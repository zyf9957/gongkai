<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高德地图周边搜索工具 - 修复版</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        /* 样式部分保持不变 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 1;
            min-width: 300px;
            padding: 15px;
        }
        
        .result-section {
            flex: 2;
            min-width: 300px;
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 150px;
            font-family: monospace;
            resize: vertical;
        }
        
        .help-text {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
        
        button {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
            margin-top: 5px;
        }
        
        button:hover {
            background: #1565c0;
        }
        
        button:disabled {
            background: #90caf9;
            cursor: not-allowed;
        }
        
        .result-area {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        
        .poi-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            background: white;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-name {
            font-weight: bold;
            color: #1e88e5;
        }
        
        .poi-details {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .download-btn {
            background: #4caf50;
        }
        
        .download-btn:hover {
            background: #388e3c;
        }
        
        .copy-btn {
            background: #ff9800;
        }
        
        .copy-btn:hover {
            background: #f57c00;
        }
        
        .export-btn {
            background: #9c27b0;
        }
        
        .export-btn:hover {
            background: #7b1fa2;
        }
        
        .error {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .success {
            color: #4caf50;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .location-group {
            display: flex;
            gap: 10px;
        }
        
        .location-group input {
            flex: 2;
        }
        
        .location-group button {
            flex: 1;
            background: #ff9800;
        }
        
        .location-group button:hover {
            background: #f57c00;
        }
        
        .select2-container {
            width: 100% !important;
        }
        
        .verify-area {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            border: 1px solid #c8e6c9;
        }
        
        .verify-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .verify-buttons button {
            flex: 1;
        }
        
        .confirm-btn {
            background: #4caf50;
        }
        
        .reject-btn {
            background: #f44336;
        }
        
        .request-delay {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .request-delay input {
            width: 80px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-options button {
            flex: 1;
        }
        
        .export-area {
            margin-top: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .location-group {
                flex-direction: column;
            }
            
            .verify-buttons {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
            }
        }
        
        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 12px;
            color: #856404;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>高德地图周边搜索工具 - 修复版</h1>
            <p class="description">修复了电话、评分和人均消费字段为空的问题</p>
        </header>
        
        <div class="content">
            <div class="form-section">
                <h2>搜索参数设置</h2>
                
                <div class="form-group">
                    <label for="apiKey">高德API Key *</label>
                    <input type="text" id="apiKey" placeholder="请输入您的高德API Key" value="">
                    <div class="help-text">请确保您有高德地图Web服务API权限</div>
                </div>
                
                <div class="form-group">
                    <label for="address">地址转坐标</label>
                    <div class="location-group">
                        <input type="text" id="address" placeholder="输入地址，如：北京市朝阳区">
                        <button id="convertBtn">获取坐标</button>
                    </div>
                    <div class="help-text">输入地址后点击"获取坐标"按钮</div>
                </div>
                
                <div class="form-group">
                    <label for="location">中心点坐标 *</label>
                    <input type="text" id="location" placeholder="格式: 经度,纬度" value="116.473168,39.993015">
                    <div class="help-text">例如: 116.473168,39.993015 (经度在前，纬度在后)</div>
                    <div id="verifyArea" class="verify-area" style="display: none;">
                        <div id="verifyAddress"></div>
                        <div class="verify-buttons">
                            <button id="confirmBtn" class="confirm-btn">使用此坐标</button>
                            <button id="rejectBtn" class="reject-btn">重新输入</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="keywords">关键词</label>
                    <input type="text" id="keywords" placeholder="如: 餐厅、酒店等">
                    <div class="help-text">可选，用于筛选特定名称的地点</div>
                </div>
                
                <div class="form-group">
                    <label for="types">地点类型 (可多选)</label>
                    <select id="types" multiple="multiple">
                        <option value="050000">餐饮服务</option>
                        <option value="060000">购物服务</option>
                        <option value="080000">体育休闲服务</option>
                        <option value="090000">医疗保健服务</option>
                        <option value="100000">住宿服务</option>
                        <option value="110000">风景名胜</option>
                    </select>
                    <div class="help-text">不选择则使用API默认类型(餐饮、生活服务、商务住宅)</div>
                </div>
                
                <div class="form-group">
                    <label for="radius">搜索半径 (米)</label>
                    <input type="number" id="radius" value="3000" min="0" max="50000">
                    <div class="help-text">取值范围: 0-50000，超出按默认值5000计算</div>
                </div>
                
                <div class="form-group">
                    <label for="region">搜索区域</label>
                    <input type="text" id="region" placeholder="如: 北京、上海">
                    <div class="help-text">可选，增加指定区域内数据召回权重</div>
                </div>
                
                <div class="form-group">
                    <label for="cityLimit">是否限制在区域内</label>
                    <select id="cityLimit">
                        <option value="false">否</option>
                        <option value="true">是</option>
                    </select>
                    <div class="help-text">为"是"时，仅召回指定区域内数据</div>
                </div>
                
                <div class="form-group">
                    <label for="sortRule">排序规则</label>
                    <select id="sortRule">
                        <option value="distance">按距离排序</option>
                        <option value="weight">综合排序</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pageSize">每页数据条数</label>
                    <input type="number" id="pageSize" value="20" min="1" max="25">
                    <div class="help-text">取值范围: 1-25</div>
                </div>
                
                <div class="form-group">
                    <label for="maxPages">最大翻页数</label>
                    <input type="number" id="maxPages" value="3" min="1" max="50">
                    <div class="help-text">控制最大翻页数，每页最多25条</div>
                </div>
                
                <div class="form-group">
                    <label for="requestDelay">请求延时 (毫秒)</label>
                    <div class="request-delay">
                        <input type="number" id="requestDelay" value="1000" min="100" max="5000">
                        <span>毫秒 (建议500-1000)</span>
                    </div>
                    <div class="help-text">设置请求间隔，避免超出API限制</div>
                </div>
                
                <button id="searchBtn">开始搜索</button>
                <button id="debugBtn" style="background: #ff9800; margin-top: 5px;">调试信息</button>
            </div>
            
            <div class="result-section">
                <h2>搜索结果</h2>
                
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                
                <div class="status" id="status">等待搜索...</div>
                
                <div id="debugInfo" class="debug-info">
                    <strong>调试信息:</strong>
                    <div id="debugContent"></div>
                </div>
                
                <div class="result-area" id="resultArea">
                    <!-- 搜索结果将在这里显示 -->
                </div>
                
                <div class="export-options">
                    <button id="downloadBtn" class="download-btn" disabled>下载CSV文件</button>
                    <button id="copyBtn" class="copy-btn" disabled>复制CSV数据</button>
                    <button id="exportBtn" class="export-btn" disabled>显示CSV数据</button>
                </div>
                
                <div id="exportArea" class="export-area">
                    <label for="csvData">CSV数据 (可全选复制):</label>
                    <textarea id="csvData" readonly></textarea>
                </div>
                
                <div id="errorArea" class="error"></div>
                <div id="successArea" class="success"></div>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery (Select2 依赖) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 引入 Select2 脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化中...');
            
            // 初始化Select2多选下拉框
            try {
                $('#types').select2({
                    placeholder: "请选择地点类型 (不选则使用默认)",
                    allowClear: true,
                    width: '100%'
                });
                console.log('Select2初始化成功');
            } catch (e) {
                console.error('Select2初始化失败:', e);
            }
            
            // 获取DOM元素
            const searchBtn = document.getElementById('searchBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const exportBtn = document.getElementById('exportBtn');
            const convertBtn = document.getElementById('convertBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const debugBtn = document.getElementById('debugBtn');
            const resultArea = document.getElementById('resultArea');
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            const errorArea = document.getElementById('errorArea');
            const successArea = document.getElementById('successArea');
            const verifyArea = document.getElementById('verifyArea');
            const verifyAddress = document.getElementById('verifyAddress');
            const exportArea = document.getElementById('exportArea');
            const csvData = document.getElementById('csvData');
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            let searchResults = [];
            let currentConvertedLocation = '';
            let csvContent = '';
            let isSearching = false;
            
            // 添加调试按钮事件
            debugBtn.addEventListener('click', function() {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                updateDebugInfo('调试面板已切换显示状态');
            });
            
            // 更新调试信息
            function updateDebugInfo(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // 地址转坐标按钮点击事件
            convertBtn.addEventListener('click', function() {
                const address = document.getElementById('address').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!address) {
                    showError('请输入地址');
                    return;
                }
                
                if (!apiKey) {
                    showError('请输入高德API Key');
                    return;
                }
                
                convertAddressToCoordinates(address, apiKey);
            });
            
            // 确认坐标按钮点击事件
            confirmBtn.addEventListener('click', function() {
                document.getElementById('location').value = currentConvertedLocation;
                verifyArea.style.display = 'none';
                showSuccess('坐标已确认并设置');
            });
            
            // 拒绝坐标按钮点击事件
            rejectBtn.addEventListener('click', function() {
                verifyArea.style.display = 'none';
                showError('请重新输入地址或坐标');
            });
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                if (isSearching) {
                    showError('搜索正在进行中，请等待完成');
                    return;
                }
                
                // 验证必填字段
                const apiKey = document.getElementById('apiKey').value.trim();
                const location = document.getElementById('location').value.trim();
                
                if (!apiKey) {
                    showError('请输入高德API Key');
                    updateDebugInfo('错误: 未输入API Key');
                    return;
                }
                
                if (!location) {
                    showError('请输入中心点坐标');
                    updateDebugInfo('错误: 未输入坐标');
                    return;
                }
                
                // 验证坐标格式
                const locationParts = location.split(',');
                if (locationParts.length !== 2 || isNaN(parseFloat(locationParts[0])) || isNaN(parseFloat(locationParts[1]))) {
                    showError('坐标格式不正确，应为"经度,纬度"格式');
                    updateDebugInfo('错误: 坐标格式不正确');
                    return;
                }
                
                // 重置状态
                resetUI();
                searchResults = [];
                isSearching = true;
                
                // 获取搜索参数
                const params = {
                    apiKey: apiKey,
                    location: location,
                    keywords: document.getElementById('keywords').value.trim(),
                    types: $('#types').val() || [], // 使用Select2获取多选值
                    radius: document.getElementById('radius').value,
                    region: document.getElementById('region').value.trim(),
                    cityLimit: document.getElementById('cityLimit').value,
                    sortRule: document.getElementById('sortRule').value,
                    pageSize: document.getElementById('pageSize').value,
                    maxPages: document.getElementById('maxPages').value,
                    requestDelay: document.getElementById('requestDelay').value
                };
                
                updateDebugInfo(`开始搜索，参数: ${JSON.stringify(params)}`);
                
                // 执行搜索
                performSearch(params);
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', function() {
                if (searchResults.length === 0) {
                    showError('没有数据可下载');
                    return;
                }
                
                // 确保CSV内容已生成
                if (!csvContent) {
                    csvContent = generateCSVContent(searchResults);
                }
                
                downloadCSV(searchResults);
            });
            
            // 复制按钮点击事件
            copyBtn.addEventListener('click', function() {
                // 确保CSV内容已生成
                if (!csvContent) {
                    if (searchResults.length === 0) {
                        showError('没有数据可复制');
                        return;
                    }
                    csvContent = generateCSVContent(searchResults);
                }
                
                copyToClipboard(csvContent);
            });
            
            // 显示CSV数据按钮点击事件
            exportBtn.addEventListener('click', function() {
                // 确保CSV内容已生成
                if (!csvContent) {
                    if (searchResults.length === 0) {
                        showError('没有数据可显示');
                        return;
                    }
                    csvContent = generateCSVContent(searchResults);
                }
                
                csvData.value = csvContent;
                exportArea.style.display = 'block';
                showSuccess('CSV数据已显示在下方文本框中，可全选复制');
            });
            
            // 地址转坐标函数
            async function convertAddressToCoordinates(address, apiKey) {
                convertBtn.disabled = true;
                convertBtn.textContent = '转换中...';
                showError('');
                showSuccess('');
                updateDebugInfo(`开始地址转坐标: ${address}`);
                
                try {
                    const url = 'https://restapi.amap.com/v3/geocode/geo';
                    const params = new URLSearchParams({
                        key: apiKey,
                        address: address,
                        output: 'json'
                    });
                    
                    updateDebugInfo(`请求URL: ${url}?${params.toString().replace(apiKey, '***')}`);
                    
                    const response = await fetch(`${url}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    updateDebugInfo(`地址转换响应: ${JSON.stringify(result)}`);
                    
                    if (result.status === '1' && result.geocodes && result.geocodes.length > 0) {
                        const location = result.geocodes[0].location;
                        currentConvertedLocation = location;
                        updateDebugInfo(`转换成功，坐标: ${location}`);
                        
                        // 验证坐标准确性
                        await verifyCoordinates(location, apiKey);
                        
                    } else {
                        throw new Error(result.info || '地址转换失败');
                    }
                } catch (error) {
                    const errorMsg = `地址转换失败: ${error.message}`;
                    showError(errorMsg);
                    updateDebugInfo(errorMsg);
                } finally {
                    convertBtn.disabled = false;
                    convertBtn.textContent = '获取坐标';
                }
            }
            
            // 验证坐标准确性
            async function verifyCoordinates(location, apiKey) {
                try {
                    const url = 'https://restapi.amap.com/v3/geocode/regeo';
                    const params = new URLSearchParams({
                        key: apiKey,
                        location: location,
                        output: 'json',
                        extensions: 'base'
                    });
                    
                    updateDebugInfo(`验证坐标URL: ${url}?${params.toString().replace(apiKey, '***')}`);
                    
                    const response = await fetch(`${url}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    updateDebugInfo(`坐标验证响应: ${JSON.stringify(result)}`);
                    
                    if (result.status === '1' && result.regeocode) {
                        const address = result.regeocode.formatted_address;
                        verifyAddress.innerHTML = `
                            <strong>坐标对应地址:</strong><br>
                            ${address}<br><br>
                            <strong>坐标:</strong> ${location}
                        `;
                        verifyArea.style.display = 'block';
                        showSuccess('坐标已获取，请确认地址是否正确');
                        updateDebugInfo('坐标验证成功');
                    } else {
                        throw new Error('坐标验证失败');
                    }
                } catch (error) {
                    const errorMsg = `坐标验证失败: ${error.message}`;
                    showError(errorMsg);
                    updateDebugInfo(errorMsg);
                }
            }
            
            // 执行搜索
            async function performSearch(params) {
                searchBtn.disabled = true;
                searchBtn.textContent = '搜索中...';
                status.textContent = '开始搜索...';
                isSearching = true;
                
                try {
                    const totalPages = parseInt(params.maxPages);
                    let currentPage = 1;
                    let totalCount = 0;
                    let requestDelay = parseInt(params.requestDelay) || 500;
                    
                    updateDebugInfo(`开始搜索，总页数: ${totalPages}, 延时: ${requestDelay}ms`);
                    
                    while (currentPage <= totalPages) {
                        status.textContent = `正在获取第 ${currentPage}/${totalPages} 页数据...`;
                        progress.style.width = `${(currentPage / totalPages) * 100}%`;
                        updateDebugInfo(`正在请求第 ${currentPage} 页数据`);
                        
                        const pageData = await fetchPageData(params, currentPage);
                        
                        if (!pageData) {
                            const errorMsg = `第 ${currentPage} 页请求失败`;
                            showError(errorMsg);
                            updateDebugInfo(errorMsg);
                            break;
                        }
                        
                        updateDebugInfo(`第 ${currentPage} 页响应: ${JSON.stringify(pageData).substring(0, 200)}...`);
                        
                        if (pageData.status !== '1') {
                            if (pageData.info && pageData.info.includes('CUQPS_HAS_EXCEEDED_THE_LIMIT')) {
                                const errorMsg = 'API请求频率超限，请增加请求延时或稍后再试';
                                showError(errorMsg);
                                updateDebugInfo(errorMsg);
                                break;
                            } else {
                                const errorMsg = `第 ${currentPage} 页请求失败: ${pageData.info || '未知错误'}`;
                                showError(errorMsg);
                                updateDebugInfo(errorMsg);
                                break;
                            }
                        }
                        
                        // 如果是第一页，获取总数量
                        if (currentPage === 1) {
                            totalCount = parseInt(pageData.count);
                            status.textContent = `搜索成功! 总共找到 ${totalCount} 个POI`;
                            updateDebugInfo(`总POI数量: ${totalCount}`);
                        }
                        
                        // 添加当前页数据
                        if (pageData.pois && pageData.pois.length > 0) {
                            searchResults.push(...pageData.pois);
                            updateResultDisplay(searchResults);
                            updateDebugInfo(`第 ${currentPage} 页获取到 ${pageData.pois.length} 条数据`);
                        } else {
                            updateDebugInfo(`第 ${currentPage} 页无数据`);
                        }
                        
                        // 如果当前页数据少于页面大小，说明是最后一页
                        if (pageData.pois.length < parseInt(params.pageSize)) {
                            status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                            updateDebugInfo(`数据获取完成，实际获取 ${searchResults.length} 条数据`);
                            break;
                        }
                        
                        currentPage++;
                        
                        // 添加延时，避免请求过快
                        updateDebugInfo(`等待 ${requestDelay}ms 后请求下一页`);
                        await new Promise(resolve => setTimeout(resolve, requestDelay));
                    }
                    
                    if (searchResults.length > 0) {
                        status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                        downloadBtn.disabled = false;
                        copyBtn.disabled = false;
                        exportBtn.disabled = false;
                        
                        // 生成CSV内容
                        csvContent = generateCSVContent(searchResults);
                        showSuccess('搜索完成，可以选择下载、复制或显示CSV数据');
                        updateDebugInfo('搜索完成，CSV内容已生成');
                    } else {
                        status.textContent = '未找到任何数据';
                        updateDebugInfo('搜索完成，未找到数据');
                    }
                    
                } catch (error) {
                    const errorMsg = `搜索失败: ${error.message}`;
                    showError(errorMsg);
                    updateDebugInfo(errorMsg);
                    console.error('搜索错误:', error);
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.textContent = '开始搜索';
                    progress.style.width = '100%';
                    isSearching = false;
                    updateDebugInfo('搜索过程结束');
                }
            }
            
            // 获取单页数据 - 修复版：使用v3 API并正确处理参数
            async function fetchPageData(params, pageNum) {
                // 使用v3接口而不是v5接口
                const url = 'https://restapi.amap.com/v3/place/around';
                
                // 构建请求参数
                const requestParams = new URLSearchParams({
                    key: params.apiKey,
                    location: params.location,
                    radius: params.radius,
                    sortrule: params.sortRule,
                    offset: params.pageSize, // v3使用offset而不是page_size
                    page: pageNum, // v3使用page而不是page_num
                    extensions: 'all', // 必须添加这个参数来获取biz_ext等深度信息
                    output: 'json'
                });
                
                // 添加可选参数
                if (params.keywords) requestParams.append('keywords', params.keywords);
                if (params.types && params.types.length > 0) requestParams.append('types', params.types.join('|'));
                if (params.region) requestParams.append('city', params.region); // v3使用city而不是region
                if (params.cityLimit) requestParams.append('city_limit', params.cityLimit);
                
                const fullUrl = `${url}?${requestParams.toString()}`;
                updateDebugInfo(`请求URL: ${fullUrl.replace(params.apiKey, '***')}`);
                
                try {
                    const response = await fetch(fullUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('请求失败:', error);
                    updateDebugInfo(`请求失败: ${error.message}`);
                    return null;
                }
            }
            
            // 更新结果显示 - 修复版：正确处理biz_ext字段
            function updateResultDisplay(pois) {
                resultArea.innerHTML = '';
                
                if (pois.length === 0) {
                    resultArea.innerHTML = '<div class="no-data">未找到任何数据</div>';
                    return;
                }
                
                pois.forEach((poi, index) => {
                    const poiElement = document.createElement('div');
                    poiElement.className = 'poi-item';
                    
                    // 处理biz_ext字段 - 从字符串解析为对象
                    let bizExt = {};
                    try {
                        if (poi.biz_ext && typeof poi.biz_ext === 'string') {
                            bizExt = JSON.parse(poi.biz_ext);
                        } else if (poi.biz_ext && typeof poi.biz_ext === 'object') {
                            bizExt = poi.biz_ext;
                        }
                    } catch (e) {
                        console.warn('解析biz_ext失败:', e);
                    }
                    
                    // 获取评分和人均消费
                    const rating = bizExt.rating || poi.rating || '无';
                    const cost = bizExt.cost || poi.cost || '无';
                    const telephone = poi.tel || '无';
                    const distance = poi.distance || '无';
                    const distanceText = distance === '无' ? distance : `${distance}米`;
                    
                    // 处理图片链接，最多显示3个图片链接
                    const photos = poi.photos || [];
                    const maxPhotosToShow = 3;
                    let photoUrlsText = '';
                    
                    if (photos.length > 0) {
                        photoUrlsText = '<div>图片链接:</div>';
                        photos.slice(0, maxPhotosToShow).forEach((photo, imgIndex) => {
                            if (photo.url) {
                                photoUrlsText += `<div>图片链接${imgIndex + 1}: ${photo.url}</div>`;
                            }
                        });
                        
                        if (photos.length > maxPhotosToShow) {
                            photoUrlsText += `<div>还有 ${photos.length - maxPhotosToShow} 个图片链接未显示</div>`;
                        }
                    } else {
                        photoUrlsText = '<div>图片链接: 无</div>';
                    }
                    
                    poiElement.innerHTML = `
                        <div class="poi-name">${index + 1}. ${poi.name || '未知名称'}</div>
                        <div class="poi-details">
                            <div>地址: ${poi.address || '未知地址'}</div>
                            <div>电话: ${telephone}</div>
                            <div>评分: ${rating}</div>
                            <div>人均消费: ${cost}</div>
                            <div>距离: ${distanceText}</div>
                            <div>类型: ${poi.type || '未知类型'}</div>
                            ${photoUrlsText}
                        </div>
                    `;
                    
                    resultArea.appendChild(poiElement);
                });
            }
            
            // 生成CSV内容 - 修复版：正确处理biz_ext字段
            function generateCSVContent(pois) {
                // CSV标题行
                const headers = ['名称', 'ID', '坐标', '类型', '分类编码', '地址', '省份', '城市', '区县', '电话', '评分', '人均消费', '距离(米)', '商圈', '图片链接1', '图片链接2', '图片链接3'];
                
                // 构建CSV内容
                let csvContent = headers.join(',') + '\n';
                
                pois.forEach(poi => {
                    // 处理biz_ext字段
                    let bizExt = {};
                    try {
                        if (poi.biz_ext && typeof poi.biz_ext === 'string') {
                            bizExt = JSON.parse(poi.biz_ext);
                        } else if (poi.biz_ext && typeof poi.biz_ext === 'object') {
                            bizExt = poi.biz_ext;
                        }
                    } catch (e) {
                        console.warn('解析biz_ext失败:', e);
                    }
                    
                    // 获取评分和人均消费
                    const rating = bizExt.rating || poi.rating || '';
                    const cost = bizExt.cost || poi.cost || '';
                    const telephone = poi.tel || '';
                    const distance = poi.distance || '';
                    
                    // 处理图片链接，最多导出3个
                    const photos = poi.photos || [];
                    const photoUrl1 = photos.length > 0 && photos[0].url ? photos[0].url : '';
                    const photoUrl2 = photos.length > 1 && photos[1].url ? photos[1].url : '';
                    const photoUrl3 = photos.length > 2 && photos[2].url ? photos[2].url : '';
                    
                    const row = [
                        `"${(poi.name || '').replace(/"/g, '""')}"`,
                        `"${poi.id || ''}"`,
                        `"${poi.location || ''}"`,
                        `"${(poi.type || '').replace(/"/g, '""')}"`,
                        `"${poi.typecode || ''}"`,
                        `"${(poi.address || '').replace(/"/g, '""')}"`,
                        `"${poi.pname || ''}"`,
                        `"${poi.cityname || ''}"`,
                        `"${poi.adname || ''}"`,
                        `"${telephone}"`,
                        `"${rating}"`,
                        `"${cost}"`,
                        `"${distance}"`,
                        `"${(poi.business_area || '').replace(/"/g, '""')}"`,
                        `"${photoUrl1}"`,
                        `"${photoUrl2}"`,
                        `"${photoUrl3}"`
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
                
                return csvContent;
            }
            
            // 下载CSV文件
            function downloadCSV(pois) {
                if (pois.length === 0) {
                    showError('没有数据可下载');
                    return;
                }
                
                if (!csvContent) {
                    csvContent = generateCSVContent(pois);
                }
                
                // 创建下载链接
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                
                // 生成文件名，包含当前日期时间
                const now = new Date();
                const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
                link.setAttribute('download', `周边搜索_${dateStr}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showSuccess('CSV文件已开始下载');
                updateDebugInfo('CSV文件下载已触发');
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                if (!text || text.trim() === '') {
                    showError('没有数据可复制');
                    return;
                }
                
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showSuccess('CSV数据已复制到剪贴板');
                        updateDebugInfo('数据已复制到剪贴板');
                    } else {
                        showError('复制失败，请手动复制');
                        updateDebugInfo('复制到剪贴板失败');
                    }
                } catch (err) {
                    document.body.removeChild(textArea);
                    showError('复制失败，请手动复制');
                    updateDebugInfo('复制到剪贴板异常: ' + err.message);
                }
            }
            
            // 重置UI状态
            function resetUI() {
                resultArea.innerHTML = '';
                status.textContent = '等待搜索...';
                progress.style.width = '0%';
                downloadBtn.disabled = true;
                copyBtn.disabled = true;
                exportBtn.disabled = true;
                exportArea.style.display = 'none';
                errorArea.textContent = '';
                successArea.textContent = '';
                csvContent = '';
                updateDebugInfo('UI状态已重置');
            }
            
            // 显示错误信息
            function showError(message) {
                errorArea.textContent = message;
                successArea.textContent = '';
            }
            
            // 显示成功信息
            function showSuccess(message) {
                successArea.textContent = message;
                errorArea.textContent = '';
            }
            
            // 初始化完成
            updateDebugInfo('页面初始化完成，可以开始搜索');
            console.log('高德地图搜索工具初始化完成');
        });
    </script>
</body>
</html>