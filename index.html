<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高德地图周边搜索工具</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 1;
            min-width: 300px;
            padding: 15px;
        }
        
        .result-section {
            flex: 1;
            min-width: 300px;
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .help-text {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
        
        button {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1565c0;
        }
        
        button:disabled {
            background: #90caf9;
            cursor: not-allowed;
        }
        
        .result-area {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        
        .poi-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-name {
            font-weight: bold;
            color: #1e88e5;
        }
        
        .poi-details {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .download-btn {
            background: #4caf50;
            margin-top: 15px;
        }
        
        .download-btn:hover {
            background: #388e3c;
        }
        
        .error {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>高德地图周边搜索工具</h1>
            <p class="description">无需编程知识，轻松搜索周边地点信息</p>
        </header>
        
        <div class="content">
            <div class="form-section">
                <h2>搜索参数设置</h2>
                
                <div class="form-group">
                    <label for="apiKey">高德API Key *</label>
                    <input type="text" id="apiKey" placeholder="请输入您的高德API Key">
                    <div class="help-text">请确保您有高德地图Web服务API权限</div>
                </div>
                
                <div class="form-group">
                    <label for="location">中心点坐标 *</label>
                    <input type="text" id="location" placeholder="格式: 经度,纬度" value="116.473168,39.993015">
                    <div class="help-text">例如: 116.473168,39.993015 (经度在前，纬度在后)</div>
                </div>
                
                <div class="form-group">
                    <label for="keywords">关键词</label>
                    <input type="text" id="keywords" placeholder="如: 餐厅、酒店等">
                    <div class="help-text">可选，用于筛选特定名称的地点</div>
                </div>
                
                <div class="form-group">
                    <label for="types">地点类型</label>
                    <select id="types">
                        <option value="">-- 使用默认类型 --</option>
                        <option value="050000">餐饮服务</option>
                        <option value="060000">购物服务</option>
                        <option value="070000">生活服务</option>
                        <option value="110000">风景名胜</option>
                        <option value="120000">商务住宅</option>
                        <option value="130000">政府机构</option>
                        <option value="150000">交通设施</option>
                        <option value="160000">金融保险</option>
                        <option value="170000">公司企业</option>
                    </select>
                    <div class="help-text">不选择则使用API默认类型(餐饮、生活服务、商务住宅)</div>
                </div>
                
                <div class="form-group">
                    <label for="radius">搜索半径 (米)</label>
                    <input type="number" id="radius" value="5000" min="0" max="50000">
                    <div class="help-text">取值范围: 0-50000，超出按默认值5000计算</div>
                </div>
                
                <div class="form-group">
                    <label for="region">搜索区域</label>
                    <input type="text" id="region" placeholder="如: 北京、上海">
                    <div class="help-text">可选，增加指定区域内数据召回权重</div>
                </div>
                
                <div class="form-group">
                    <label for="cityLimit">是否限制在区域内</label>
                    <select id="cityLimit">
                        <option value="false">否</option>
                        <option value="true">是</option>
                    </select>
                    <div class="help-text">为"是"时，仅召回指定区域内数据</div>
                </div>
                
                <div class="form-group">
                    <label for="sortRule">排序规则</label>
                    <select id="sortRule">
                        <option value="distance">按距离排序</option>
                        <option value="weight">综合排序</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pageSize">每页数据条数</label>
                    <input type="number" id="pageSize" value="20" min="1" max="25">
                    <div class="help-text">取值范围: 1-25</div>
                </div>
                
                <div class="form-group">
                    <label for="maxPages">最大翻页数</label>
                    <input type="number" id="maxPages" value="10" min="1" max="50">
                    <div class="help-text">控制最大翻页数，每页最多25条</div>
                </div>
                
                <button id="searchBtn">开始搜索</button>
            </div>
            
            <div class="result-section">
                <h2>搜索结果</h2>
                
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                
                <div class="status" id="status">等待搜索...</div>
                
                <div class="result-area" id="resultArea">
                    <!-- 搜索结果将在这里显示 -->
                </div>
                
                <button id="downloadBtn" class="download-btn" disabled>下载CSV文件</button>
                
                <div id="errorArea" class="error"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const searchBtn = document.getElementById('searchBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const resultArea = document.getElementById('resultArea');
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            const errorArea = document.getElementById('errorArea');
            
            let searchResults = [];
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                // 验证必填字段
                const apiKey = document.getElementById('apiKey').value.trim();
                const location = document.getElementById('location').value.trim();
                
                if (!apiKey) {
                    showError('请输入高德API Key');
                    return;
                }
                
                if (!location) {
                    showError('请输入中心点坐标');
                    return;
                }
                
                // 重置状态
                resetUI();
                searchResults = [];
                
                // 获取搜索参数
                const params = {
                    apiKey: apiKey,
                    location: location,
                    keywords: document.getElementById('keywords').value.trim(),
                    types: document.getElementById('types').value,
                    radius: document.getElementById('radius').value,
                    region: document.getElementById('region').value.trim(),
                    cityLimit: document.getElementById('cityLimit').value,
                    sortRule: document.getElementById('sortRule').value,
                    pageSize: document.getElementById('pageSize').value,
                    maxPages: document.getElementById('maxPages').value
                };
                
                // 执行搜索
                performSearch(params);
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', function() {
                if (searchResults.length === 0) {
                    showError('没有数据可下载');
                    return;
                }
                
                downloadCSV(searchResults);
            });
            
            // 执行搜索
            async function performSearch(params) {
                searchBtn.disabled = true;
                status.textContent = '开始搜索...';
                
                try {
                    const totalPages = parseInt(params.maxPages);
                    let currentPage = 1;
                    let totalCount = 0;
                    
                    while (currentPage <= totalPages) {
                        status.textContent = `正在获取第 ${currentPage}/${totalPages} 页数据...`;
                        progress.style.width = `${(currentPage / totalPages) * 100}%`;
                        
                        const pageData = await fetchPageData(params, currentPage);
                        
                        if (!pageData || pageData.status !== '1') {
                            showError(`第 ${currentPage} 页请求失败: ${pageData ? pageData.info : '未知错误'}`);
                            break;
                        }
                        
                        // 如果是第一页，获取总数量
                        if (currentPage === 1) {
                            totalCount = parseInt(pageData.count);
                            status.textContent = `搜索成功! 总共找到 ${totalCount} 个POI`;
                        }
                        
                        // 添加当前页数据
                        if (pageData.pois && pageData.pois.length > 0) {
                            searchResults.push(...pageData.pois);
                            updateResultDisplay(searchResults);
                        }
                        
                        // 如果当前页数据少于页面大小，说明是最后一页
                        if (pageData.pois.length < parseInt(params.pageSize)) {
                            status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                            break;
                        }
                        
                        currentPage++;
                        
                        // 添加延时，避免请求过快
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    if (searchResults.length > 0) {
                        status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                        downloadBtn.disabled = false;
                    } else {
                        status.textContent = '未找到任何数据';
                    }
                    
                } catch (error) {
                    showError(`搜索失败: ${error.message}`);
                } finally {
                    searchBtn.disabled = false;
                    progress.style.width = '100%';
                }
            }
            
            // 获取单页数据
            async function fetchPageData(params, pageNum) {
                const url = 'https://restapi.amap.com/v5/place/around';
                
                // 构建请求参数
                const requestParams = new URLSearchParams({
                    key: params.apiKey,
                    location: params.location,
                    radius: params.radius,
                    sortrule: params.sortRule,
                    page_size: params.pageSize,
                    page_num: pageNum,
                    output: 'json'
                });
                
                // 添加可选参数
                if (params.keywords) requestParams.append('keywords', params.keywords);
                if (params.types) requestParams.append('types', params.types);
                if (params.region) requestParams.append('region', params.region);
                if (params.cityLimit) requestParams.append('city_limit', params.cityLimit);
                
                // 添加返回字段
                requestParams.append('show_fields', 'business,tel,rating,photos');
                
                const response = await fetch(`${url}?${requestParams.toString()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status}`);
                }
                
                return await response.json();
            }
            
            // 更新结果显示
            function updateResultDisplay(pois) {
                resultArea.innerHTML = '';
                
                pois.slice(0, 10).forEach((poi, index) => {
                    const poiElement = document.createElement('div');
                    poiElement.className = 'poi-item';
                    
                    // 处理图片链接
                    const photos = poi.photos || [];
                    const photoUrls = photos.map(photo => photo.url).filter(url => url);
                    const photoUrlsStr = photoUrls.length > 0 ? photoUrls.join('|') : '无';
                    
                    poiElement.innerHTML = `
                        <div class="poi-name">${index + 1}. ${poi.name || '未知名称'}</div>
                        <div class="poi-details">
                            <div>地址: ${poi.address || '未知地址'}</div>
                            <div>电话: ${poi.tel || '无'}</div>
                            <div>评分: ${poi.rating || '无'}</div>
                            <div>类型: ${poi.type || '未知类型'}</div>
                        </div>
                    `;
                    
                    resultArea.appendChild(poiElement);
                });
                
                if (pois.length > 10) {
                    const moreElement = document.createElement('div');
                    moreElement.className = 'poi-item';
                    moreElement.style.textAlign = 'center';
                    moreElement.textContent = `... 还有 ${pois.length - 10} 条结果`;
                    resultArea.appendChild(moreElement);
                }
            }
            
            // 下载CSV文件
            function downloadCSV(pois) {
                // CSV标题行
                const headers = ['名称', 'ID', '坐标', '类型', '分类编码', '地址', '省份', '城市', '区县', '电话', '评分', '商圈', '人均消费', '图片链接'];
                
                // 构建CSV内容
                let csvContent = headers.join(',') + '\n';
                
                pois.forEach(poi => {
                    // 处理图片链接
                    const photos = poi.photos || [];
                    const photoUrls = photos.map(photo => photo.url).filter(url => url);
                    const photoUrlsStr = photoUrls.length > 0 ? photoUrls.join('|') : '';
                    
                    const row = [
                        `"${(poi.name || '').replace(/"/g, '""')}"`,
                        `"${poi.id || ''}"`,
                        `"${poi.location || ''}"`,
                        `"${(poi.type || '').replace(/"/g, '""')}"`,
                        `"${poi.typecode || ''}"`,
                        `"${(poi.address || '').replace(/"/g, '""')}"`,
                        `"${poi.pname || ''}"`,
                        `"${poi.cityname || ''}"`,
                        `"${poi.adname || ''}"`,
                        `"${poi.tel || ''}"`,
                        `"${poi.rating || ''}"`,
                        `"${(poi.business ? poi.business.business_area : '').replace(/"/g, '""')}"`,
                        `"${poi.cost || ''}"`,
                        `"${photoUrlsStr}"`
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
                
                // 创建下载链接
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `周边搜索_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            
            // 重置UI状态
            function resetUI() {
                resultArea.innerHTML = '';
                status.textContent = '等待搜索...';
                progress.style.width = '0%';
                downloadBtn.disabled = true;
                errorArea.textContent = '';
            }
            
            // 显示错误信息
            function showError(message) {
                errorArea.textContent = message;
            }
        });
    </script>
</body>
</html>