<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高德地图周边搜索工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        /* 样式部分保持不变，新增全屏样式 */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 1;
            min-width: 300px;
            padding: 15px;
        }
        
        .result-section {
            flex: 2;
            min-width: 300px;
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 150px;
            font-family: monospace;
            resize: vertical;
        }
        
        .help-text {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
        
        button {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
            margin-top: 5px;
        }
        
        button:hover {
            background: #1565c0;
        }
        
        button:disabled {
            background: #90caf9;
            cursor: not-allowed;
        }
        
        .result-area {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        
        .poi-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            background: white;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .poi-item:hover {
            background: #f0f8ff;
            transform: translateY(-2px);
        }
        
        .poi-item.active {
            background: #e3f2fd;
            border-left: 4px solid #1e88e5;
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-name {
            font-weight: bold;
            color: #1e88e5;
        }
        
        .poi-details {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        /* 新增地图容器样式 */
        .map-section {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            height: 400px;
            display: none;
            position: relative;
        }
        
        #mapContainer {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .map-controls button {
            flex: 1;
            padding: 8px 12px;
            font-size: 14px;
        }
        
        /* 新增图片相关样式 */
        .poi-images {
            margin-top: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .poi-image {
            width: 100px;
            height: 75px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .poi-image:hover {
            transform: scale(1.05);
        }
        
        .image-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: white;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 1001;
        }
        
        .download-btn {
            background: #4caf50;
        }
        
        .download-btn:hover {
            background: #388e3c;
        }
        
        .copy-btn {
            background: #ff9800;
        }
        
        .copy-btn:hover {
            background: #f57c00;
        }
        
        .export-btn {
            background: #9c27b0;
        }
        
        .export-btn:hover {
            background: #7b1fa2;
        }
        
        .error {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .success {
            color: #4caf50;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .location-group {
            display: flex;
            gap: 10px;
        }
        
        .location-group input {
            flex: 2;
        }
        
        .location-group button {
            flex: 1;
            background: #ff9800;
        }
        
        .location-group button:hover {
            background: #f57c00;
        }
        
        .select2-container {
            width: 100% !important;
        }
        
        .verify-area {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            border: 1px solid #c8e6c9;
        }
        
        .verify-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .verify-buttons button {
            flex: 1;
        }
        
        .confirm-btn {
            background: #4caf50;
        }
        
        .reject-btn {
            background: #f44336;
        }
        
        .request-delay {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .request-delay input {
            width: 80px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-options button {
            flex: 1;
        }
        
        .export-area {
            margin-top: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .location-group {
                flex-direction: column;
            }
            
            .verify-buttons {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
            }
            
            .poi-images {
                justify-content: center;
            }
            
            .map-controls {
                flex-direction: column;
            }
        }
        
        .debug-info {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            font-size: 12px;
            color: #856404;
            display: none;
        }
        
        .view-images-btn {
            background: #607d8b;
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 3px;
            margin-top: 5px;
            display: inline-block;
        }
        
        .view-images-btn:hover {
            background: #455a64;
        }
        
        /* 新增地图按钮样式 */
        .map-toggle-btn {
            background: #9c27b0;
            margin-top: 10px;
        }
        
        .map-toggle-btn:hover {
            background: #7b1fa2;
        }
        
        .api-key-group {
            display: flex;
            gap: 10px;
        }
        
        .api-key-group input {
            flex: 2;
        }
        
        .api-key-group button {
            flex: 1;
            background: #9c27b0;
        }
        
        .api-key-group button:hover {
            background: #7b1fa2;
        }
        
        /* 安全密钥样式 */
        .security-key-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .security-key-group input {
            flex: 1;
        }
        
        /* 新增全屏样式 */
        .fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }
        
        .map-section.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            margin: 0;
            border-radius: 0;
        }
        
        /* 地址搜索结果样式 */
        .address-results {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            display: none;
        }
        
        .address-result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .address-result-item:hover {
            background: #f0f8ff;
        }
        
        .address-result-item:last-child {
            border-bottom: none;
        }
        
        .address-name {
            font-weight: bold;
            color: #1e88e5;
        }
        
        .address-details {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* 定位按钮样式 */
        .location-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .location-buttons button {
            flex: 1;
        }
        
        .current-location-btn {
            background: #ff5722;
        }
        
        .current-location-btn:hover {
            background: #e64a19;
        }
    </style>
</head>
<body>
    <!-- 图片模态框 -->
    <div id="imageModal" class="image-modal">
        <span class="close-modal">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>

    <div class="container">
        <header>
            <h1>高德地图周边搜索工具</h1>
            <p class="description">探索周边好工具 - 新增地图可视化功能</p>
        </header>
        
        <div class="content">
            <div class="form-section">
                <h2>搜索参数设置</h2>
                
                <!-- 新增地图API密钥和安全密钥输入 -->
                <div class="form-group">
                    <label for="mapApiKey">高德地图API Key (用于显示地图) *</label>
                    <div class="api-key-group">
                        <input type="text" id="mapApiKey" placeholder="请输入高德地图JavaScript API Key">
                        <button id="loadMapBtn">加载地图</button>
                    </div>
                    <div class="help-text">请确保您有高德地图JavaScript API权限</div>
                    
                    <label for="securityKey" style="margin-top: 10px;">安全密钥 (Security Key)</label>
                    <div class="security-key-group">
                        <input type="text" id="securityKey" placeholder="请输入安全密钥 (可选)">
                    </div>
                    <div class="help-text">如果您的API Key配置了安全密钥，请在此输入</div>
                </div>
                
                <div class="form-group">
                    <label for="apiKey">高德Web服务API Key (用于搜索) *</label>
                    <input type="text" id="apiKey" placeholder="请输入高德Web服务API Key" value="">
                    <div class="help-text">请确保您有高德地图Web服务API权限</div>
                </div>
                
                <div class="form-group">
                    <label for="address">地址转坐标</label>
                    <div class="location-group">
                        <input type="text" id="address" placeholder="输入地址，如：北京市朝阳区">
                        <button id="convertBtn">获取坐标</button>
                    </div>
                    <div class="help-text">输入地址后点击"获取坐标"按钮</div>
                    
                    <!-- 新增定位当前位置按钮 -->
                    <div class="location-buttons">
                        <button id="currentLocationBtn" class="current-location-btn">定位当前位置</button>
                    </div>
                    
                    <!-- 地址搜索结果列表 -->
                    <div id="addressResults" class="address-results"></div>
                </div>
                
                <div class="form-group">
                    <label for="location">中心点坐标 *</label>
                    <input type="text" id="location" placeholder="格式: 经度,纬度" value="116.473168,39.993015">
                    <div class="help-text">例如: 116.473168,39.993015 (经度在前，纬度在后)</div>
                    <div id="verifyArea" class="verify-area" style="display: none;">
                        <div id="verifyAddress"></div>
                        <div class="verify-buttons">
                            <button id="confirmBtn" class="confirm-btn">使用此坐标</button>
                            <button id="rejectBtn" class="reject-btn">重新输入</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="keywords">关键词</label>
                    <input type="text" id="keywords" placeholder="如: 餐厅、酒店等">
                    <div class="help-text">可选，用于筛选特定名称的地点</div>
                </div>
                
                <div class="form-group">
                    <label for="types">地点类型 (可多选)</label>
                    <select id="types" multiple="multiple">
                        <option value="050000">餐饮服务</option>
                        <option value="060000">购物服务</option>
                        <option value="080000">体育休闲服务</option>
                        <option value="090000">医疗保健服务</option>
                        <option value="100000">住宿服务</option>
                        <option value="110000">风景名胜</option>
                    </select>
                    <div class="help-text">不选择则使用API默认类型(餐饮、生活服务、商务住宅)</div>
                </div>
                
                <div class="form-group">
                    <label for="radius">搜索半径 (米)</label>
                    <input type="number" id="radius" value="500" min="0" max="50000">
                    <div class="help-text">取值范围: 0-50000，超出按默认值5000计算</div>
                </div>
                
                <div class="form-group">
                    <label for="region">搜索区域</label>
                    <input type="text" id="region" placeholder="如: 北京、上海">
                    <div class="help-text">可选，增加指定区域内数据召回权重</div>
                </div>
                
                <div class="form-group">
                    <label for="cityLimit">是否限制在区域内</label>
                    <select id="cityLimit">
                        <option value="false">否</option>
                        <option value="true">是</option>
                    </select>
                    <div class="help-text">为"是"时，仅召回指定区域内数据</div>
                </div>
                
                <div class="form-group">
                    <label for="sortRule">排序规则</label>
                    <select id="sortRule">
                        <option value="distance">按距离排序</option>
                        <option value="weight">综合排序</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pageSize">每页数据条数</label>
                    <input type="number" id="pageSize" value="20" min="1" max="25">
                    <div class="help-text">取值范围: 1-25</div>
                </div>
                
                <div class="form-group">
                    <label for="maxPages">最大翻页数</label>
                    <input type="number" id="maxPages" value="10" min="1" max="50">
                    <div class="help-text">控制最大翻页数，每页最多25条</div>
                </div>
                
                <div class="form-group">
                    <label for="requestDelay">请求延时 (毫秒)</label>
                    <div class="request-delay">
                        <input type="number" id="requestDelay" value="1000" min="100" max="5000">
                        <span>毫秒 (建议500-1000)</span>
                    </div>
                    <div class="help-text">设置请求间隔，避免超出API限制</div>
                </div>
                
                <button id="searchBtn">开始搜索</button>
                <!-- 修改地图显示按钮，初始状态为禁用 -->
                <button id="toggleMapBtn" class="map-toggle-btn" disabled>显示地图 (请先加载地图)</button>
                <button id="debugBtn" style="background: #ff9800; margin-top: 5px;">调试信息</button>
            </div>
            
            <div class="result-section">
                <h2>搜索结果</h2>
                
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                
                <div class="status" id="status">等待搜索...</div>
                
                <div id="debugInfo" class="debug-info">
                    <strong>调试信息:</strong>
                    <div id="debugContent"></div>
                </div>
                
                <div class="result-area" id="resultArea">
                    <!-- 搜索结果将在这里显示 -->
                </div>
                
                <!-- 新增地图容器和控件 -->
                <div class="map-section" id="mapSection">
                    <button id="fullscreenBtn" class="fullscreen-btn">全屏</button>
                    <div id="mapContainer"></div>
                    <div class="map-controls">
                        <button id="clearMarkersBtn" class="clear-markers-btn">清除标记</button>
                        <button id="fitViewBtn" class="fit-view-btn">调整视野</button>
                        <button id="showCenterBtn" class="show-center-btn">显示中心点</button>
                    </div>
                </div>
                
                <div class="export-options">
                    <button id="downloadBtn" class="download-btn" disabled>下载CSV文件</button>
                    <button id="copyBtn" class="copy-btn" disabled>复制CSV数据</button>
                    <button id="exportBtn" class="export-btn" disabled>显示CSV数据</button>
                </div>
                
                <div id="exportArea" class="export-area">
                    <label for="csvData">CSV数据 (可全选复制):</label>
                    <textarea id="csvData" readonly></textarea>
                </div>
                
                <div id="errorArea" class="error"></div>
                <div id="successArea" class="success"></div>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery (Select2 依赖) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 引入 Select2 脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化中...');
            
            // 初始化Select2多选下拉框
            try {
                $('#types').select2({
                    placeholder: "请选择地点类型 (不选则使用默认)",
                    allowClear: true,
                    width: '100%'
                });
                console.log('Select2初始化成功');
            } catch (e) {
                console.error('Select2初始化失败:', e);
            }
            
            // 获取DOM元素
            const searchBtn = document.getElementById('searchBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const exportBtn = document.getElementById('exportBtn');
            const convertBtn = document.getElementById('convertBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const debugBtn = document.getElementById('debugBtn');
            const resultArea = document.getElementById('resultArea');
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            const errorArea = document.getElementById('errorArea');
            const successArea = document.getElementById('successArea');
            const verifyArea = document.getElementById('verifyArea');
            const verifyAddress = document.getElementById('verifyAddress');
            const exportArea = document.getElementById('exportArea');
            const csvData = document.getElementById('csvData');
            const debugInfo = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            // 新增地图相关元素
            const mapSection = document.getElementById('mapSection');
            const toggleMapBtn = document.getElementById('toggleMapBtn');
            const clearMarkersBtn = document.getElementById('clearMarkersBtn');
            const fitViewBtn = document.getElementById('fitViewBtn');
            const showCenterBtn = document.getElementById('showCenterBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const loadMapBtn = document.getElementById('loadMapBtn');
            const mapApiKeyInput = document.getElementById('mapApiKey');
            const securityKeyInput = document.getElementById('securityKey');
            
            // 新增地址搜索相关元素
            const addressInput = document.getElementById('address');
            const addressResults = document.getElementById('addressResults');
            const currentLocationBtn = document.getElementById('currentLocationBtn');
            
            // 获取图片模态框相关元素
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const closeModal = document.querySelector('.close-modal');
            
            let searchResults = [];
            let currentConvertedLocation = '';
            let csvContent = '';
            let isSearching = false;
            
            // 地图相关变量
            let map = null;
            let markers = [];
            let infoWindows = [];
            let markerCluster = null;
            let isMapInitialized = false;
            let isMapVisible = false;
            let isMapLoaded = false;
            let centerMarker = null; // 中心点标记
            
            // 添加调试按钮事件
            debugBtn.addEventListener('click', function() {
                debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
                updateDebugInfo('调试面板已切换显示状态');
            });
            
            // 图片模态框事件
            closeModal.addEventListener('click', function() {
                imageModal.style.display = 'none';
            });
            
            // 点击模态框背景关闭
            imageModal.addEventListener('click', function(e) {
                if (e.target === imageModal) {
                    imageModal.style.display = 'none';
                }
            });
            
            // 加载地图按钮事件
            loadMapBtn.addEventListener('click', function() {
                const mapApiKey = mapApiKeyInput.value.trim();
                const securityKey = securityKeyInput.value.trim();
                
                if (!mapApiKey) {
                    showError('请输入高德地图API Key');
                    return;
                }
                
                loadMapBtn.disabled = true;
                loadMapBtn.textContent = '加载中...';
                
                loadAmapScript(mapApiKey, securityKey);
            });
            
            // 加载高德地图脚本
            function loadAmapScript(apiKey, securityKey) {
                if (window.AMap) {
                    // 如果已经加载过，直接初始化
                    initMap();
                    return;
                }
                
                // 构建API URL - 使用更稳定的版本
                let apiUrl = `https://webapi.amap.com/maps?v=1.4.15&key=${apiKey}`;
                
                // 如果有安全密钥，添加到URL中
                if (securityKey) {
                    apiUrl += `&security=${securityKey}`;
                }
                
                const script = document.createElement('script');
                script.type = 'text/javascript';
                script.src = apiUrl;
                script.onload = function() {
                    updateDebugInfo('高德地图API加载成功');
                    // 加载点聚合插件
                    loadMarkerClusterer();
                };
                script.onerror = function() {
                    showError('高德地图API加载失败，请检查API Key和安全密钥是否正确');
                    updateDebugInfo('高德地图API加载失败');
                    loadMapBtn.textContent = '加载地图';
                    loadMapBtn.disabled = false;
                };
                document.head.appendChild(script);
            }
            
            // 加载点聚合插件
            function loadMarkerClusterer() {
                // 检查是否已经加载了点聚合插件
                if (window.AMap && window.AMap.MarkerClusterer) {
                    updateDebugInfo('点聚合插件已加载');
                    initMap();
                    return;
                }
                
                // 加载点聚合插件
                const clusterScript = document.createElement('script');
                clusterScript.type = 'text/javascript';
                clusterScript.src = 'https://a.amap.com/jsapi_demos/static/demo-center/js/markerclusterer.js';
                clusterScript.onload = function() {
                    updateDebugInfo('点聚合插件加载成功');
                    initMap();
                    loadMapBtn.textContent = '重新加载地图';
                    loadMapBtn.disabled = false;
                };
                clusterScript.onerror = function() {
                    updateDebugInfo('点聚合插件加载失败，将使用普通标记');
                    // 即使点聚合插件加载失败，也继续初始化地图
                    initMap();
                    loadMapBtn.textContent = '重新加载地图';
                    loadMapBtn.disabled = false;
                };
                document.head.appendChild(clusterScript);
            }
            
            // 地图控制按钮事件
            toggleMapBtn.addEventListener('click', function() {
                if (!isMapLoaded) {
                    showError('请先加载地图');
                    return;
                }
                
                if (!isMapVisible) {
                    // 显示地图
                    if (!isMapInitialized) {
                        initMap();
                    }
                    mapSection.style.display = 'block';
                    isMapVisible = true;
                    toggleMapBtn.textContent = '隐藏地图';
                    updateDebugInfo('地图已显示');
                } else {
                    // 隐藏地图
                    mapSection.style.display = 'none';
                    isMapVisible = false;
                    toggleMapBtn.textContent = '显示地图';
                    updateDebugInfo('地图已隐藏');
                }
            });
            
            clearMarkersBtn.addEventListener('click', function() {
                clearAllMarkers();
                updateDebugInfo('所有地图标记已清除');
            });
            
            fitViewBtn.addEventListener('click', function() {
                if (isMapInitialized && map) {
                    map.setFitView();
                    updateDebugInfo('地图视野已调整');
                }
            });
            
            showCenterBtn.addEventListener('click', function() {
                showCenterMarker();
                updateDebugInfo('已显示中心点标记');
            });
            
            fullscreenBtn.addEventListener('click', function() {
                toggleFullscreen();
            });
            
            // 地址转坐标按钮事件
            convertBtn.addEventListener('click', function() {
                const address = addressInput.value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!address) {
                    showError('请输入地址');
                    return;
                }
                
                if (!apiKey) {
                    showError('请输入高德Web服务API Key');
                    return;
                }
                
                convertAddressToCoordinates(address, apiKey);
            });
            
            // 定位当前位置按钮事件
            currentLocationBtn.addEventListener('click', function() {
                getCurrentLocation();
            });
            
            // 地址输入框输入事件 - 实现实时搜索
            let searchTimeout;
            addressInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                const address = addressInput.value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (address.length < 2 || !apiKey) {
                    addressResults.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(() => {
                    searchAddress(address, apiKey);
                }, 500);
            });
            
            // 更新调试信息
            function updateDebugInfo(message) {
                const timestamp = new Date().toLocaleTimeString();
                debugContent.innerHTML += `[${timestamp}] ${message}<br>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            
            // 初始化地图
            function initMap() {
                if (!window.AMap) {
                    showError('高德地图API未加载，请先加载地图');
                    updateDebugInfo('地图初始化失败：API未加载');
                    return;
                }
                
                const location = document.getElementById('location').value.trim();
                let center = [116.473168, 39.993015]; // 默认中心点
                
                if (location) {
                    const locationParts = location.split(',');
                    if (locationParts.length === 2) {
                        center = [parseFloat(locationParts[0]), parseFloat(locationParts[1])];
                    }
                }
                
                try {
                    map = new AMap.Map('mapContainer', {
                        zoom: 14,
                        center: center,
                        viewMode: '3D'
                    });
                    
                    // 添加缩放控件
                    map.addControl(new AMap.Zoom());
                    
                    // 添加比例尺控件
                    map.addControl(new AMap.Scale());
                    
                    // 添加工具条控件
                    map.addControl(new AMap.ToolBar());
                    
                    // 显示中心点标记
                    showCenterMarker();
                    
                    isMapInitialized = true;
                    isMapLoaded = true;
                    toggleMapBtn.disabled = false;
                    toggleMapBtn.textContent = '显示地图';
                    showSuccess('地图加载成功，可以显示地图了');
                    updateDebugInfo('地图初始化成功');
                } catch (error) {
                    console.error('地图初始化失败:', error);
                    updateDebugInfo('地图初始化失败: ' + error.message);
                    showError('地图初始化失败: ' + error.message);
                    
                    // 尝试使用更简单的方式初始化地图
                    try {
                        map = new AMap.Map('mapContainer', {
                            zoom: 14,
                            center: center
                        });
                        
                        // 显示中心点标记
                        showCenterMarker();
                        
                        isMapInitialized = true;
                        isMapLoaded = true;
                        toggleMapBtn.disabled = false;
                        toggleMapBtn.textContent = '显示地图';
                        showSuccess('地图加载成功 (简化模式)');
                        updateDebugInfo('地图初始化成功 (简化模式)');
                    } catch (simpleError) {
                        console.error('简化地图初始化也失败:', simpleError);
                        updateDebugInfo('简化地图初始化失败: ' + simpleError.message);
                        showError('地图初始化失败，请检查API配置');
                    }
                }
            }
            
            // 显示中心点标记
            function showCenterMarker() {
                if (!isMapInitialized || !map) return;
                
                // 清除之前的中心点标记
                if (centerMarker) {
                    map.remove(centerMarker);
                }
                
                const location = document.getElementById('location').value.trim();
                if (!location) return;
                
                const locationParts = location.split(',');
                if (locationParts.length !== 2) return;
                
                const center = [parseFloat(locationParts[0]), parseFloat(locationParts[1])];
                
                // 创建中心点标记（使用不同颜色）
                centerMarker = new AMap.Marker({
                    position: center,
                    title: '搜索中心点',
                    content: `<div style="background-color: #ff5722; color: white; border-radius: 50%; width: 30px; height: 30px; text-align: center; line-height: 30px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">中</div>`,
                    offset: new AMap.Pixel(-15, -15),
                    zIndex: 100 // 确保中心点标记在最上层
                });
                
                // 创建信息窗口
                const infoWindow = new AMap.InfoWindow({
                    content: `<div style="padding: 10px;">
                                <h3 style="margin: 0 0 10px; color: #ff5722;">搜索中心点</h3>
                                <p><strong>坐标:</strong> ${location}</p>
                              </div>`,
                    offset: new AMap.Pixel(0, -30)
                });
                
                // 标记点击事件
                centerMarker.on('click', function() {
                    infoWindow.open(map, centerMarker.getPosition());
                });
                
                map.add(centerMarker);
            }
            
            // 在地图上添加标记
            function addMarkersToMap(pois) {
                if (!isMapInitialized || !map) {
                    updateDebugInfo('地图未初始化，无法添加标记');
                    return;
                }
                
                // 清除现有标记（保留中心点标记）
                clearSearchMarkers();
                
                // 创建标记点
                pois.forEach((poi, index) => {
                    const location = poi.location.split(',').map(Number);
                    if (location.length !== 2 || isNaN(location[0]) || isNaN(location[1])) {
                        return; // 跳过无效坐标
                    }
                    
                    // 创建标记
                    const marker = new AMap.Marker({
                        position: location,
                        title: poi.name,
                        content: `<div style="background-color: #1e88e5; color: white; border-radius: 50%; width: 30px; height: 30px; text-align: center; line-height: 30px;">${index + 1}</div>`,
                        offset: new AMap.Pixel(-15, -15)
                    });
                    
                    // 创建信息窗口内容
                    let infoContent = `
                        <div style="padding: 10px; max-width: 300px;">
                            <h3 style="margin: 0 0 10px; color: #1e88e5;">${poi.name || '未知名称'}</h3>
                            <p><strong>地址:</strong> ${poi.address || '未知地址'}</p>
                            <p><strong>电话:</strong> ${poi.tel || '无'}</p>
                            <p><strong>类型:</strong> ${poi.type || '未知类型'}</p>
                            <p><strong>距离:</strong> ${poi.distance || '无'}米</p>
                            <button onclick="focusOnPoi(${index})" style="background: #1e88e5; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">查看详情</button>
                        </div>
                    `;
                    
                    // 创建信息窗口
                    const infoWindow = new AMap.InfoWindow({
                        content: infoContent,
                        offset: new AMap.Pixel(0, -30)
                    });
                    
                    // 标记点击事件
                    marker.on('click', function() {
                        // 关闭所有信息窗口
                        infoWindows.forEach(iw => iw.close());
                        // 打开当前信息窗口
                        infoWindow.open(map, marker.getPosition());
                        // 高亮对应的列表项
                        highlightListItem(index);
                    });
                    
                    markers.push(marker);
                    infoWindows.push(infoWindow);
                });
                
                // 使用点聚合（如果可用）
                if (markers.length > 0 && window.AMap && window.AMap.MarkerClusterer) {
                    try {
                        markerCluster = new AMap.MarkerClusterer(map, markers, {
                            gridSize: 80,
                            maxZoom: 18
                        });
                        updateDebugInfo(`已使用点聚合添加 ${markers.length} 个标记`);
                    } catch (clusterError) {
                        console.error('点聚合失败:', clusterError);
                        updateDebugInfo('点聚合失败，使用普通标记: ' + clusterError.message);
                        // 点聚合失败，直接添加标记到地图
                        markers.forEach(marker => map.add(marker));
                    }
                } else if (markers.length > 0) {
                    // 点聚合不可用，直接添加标记到地图
                    markers.forEach(marker => map.add(marker));
                    updateDebugInfo(`已直接添加 ${markers.length} 个标记（点聚合不可用）`);
                }
                
                // 调整地图视野以包含所有标记
                if (markers.length > 0) {
                    map.setFitView();
                    updateDebugInfo(`已在地图上添加 ${markers.length} 个标记`);
                }
            }
            
            // 清除搜索标记（保留中心点标记）
            function clearSearchMarkers() {
                if (markerCluster && window.AMap && window.AMap.MarkerClusterer) {
                    markerCluster.clearMarkers();
                    markerCluster = null;
                }
                
                markers.forEach(marker => {
                    map.remove(marker);
                });
                
                infoWindows.forEach(infoWindow => {
                    infoWindow.close();
                });
                
                markers = [];
                infoWindows = [];
                
                updateDebugInfo('搜索标记已清除');
            }
            
            // 清除所有地图标记（包括中心点标记）
            function clearAllMarkers() {
                clearSearchMarkers();
                
                // 清除中心点标记
                if (centerMarker) {
                    map.remove(centerMarker);
                    centerMarker = null;
                }
                
                updateDebugInfo('所有地图标记已清除');
            }
            
            // 高亮列表项
            function highlightListItem(index) {
                const poiItems = document.querySelectorAll('.poi-item');
                poiItems.forEach(item => item.classList.remove('active'));
                
                if (poiItems[index]) {
                    poiItems[index].classList.add('active');
                    poiItems[index].scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            // 切换全屏
            function toggleFullscreen() {
                if (mapSection.classList.contains('fullscreen')) {
                    // 退出全屏
                    mapSection.classList.remove('fullscreen');
                    fullscreenBtn.textContent = '全屏';
                    updateDebugInfo('已退出全屏模式');
                } else {
                    // 进入全屏
                    mapSection.classList.add('fullscreen');
                    fullscreenBtn.textContent = '退出全屏';
                    updateDebugInfo('已进入全屏模式');
                }
                
                // 刷新地图
                if (map) {
                    setTimeout(() => {
                        map.setFitView();
                    }, 300);
                }
            }
            
            // 获取当前位置
            function getCurrentLocation() {
                if (!navigator.geolocation) {
                    showError('您的浏览器不支持地理位置功能');
                    return;
                }
                
                currentLocationBtn.disabled = true;
                currentLocationBtn.textContent = '定位中...';
                
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        
                        // 更新坐标输入框
                        document.getElementById('location').value = `${longitude},${latitude}`;
                        
                        // 在地图上显示当前位置
                        if (isMapInitialized && map) {
                            // 清除之前的中心点标记
                            if (centerMarker) {
                                map.remove(centerMarker);
                            }
                            
                            // 创建当前位置标记
                            centerMarker = new AMap.Marker({
                                position: [longitude, latitude],
                                title: '当前位置',
                                content: `<div style="background-color: #4caf50; color: white; border-radius: 50%; width: 30px; height: 30px; text-align: center; line-height: 30px; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);">我</div>`,
                                offset: new AMap.Pixel(-15, -15),
                                zIndex: 100
                            });
                            
                            // 创建信息窗口
                            const infoWindow = new AMap.InfoWindow({
                                content: `<div style="padding: 10px;">
                                            <h3 style="margin: 0 0 10px; color: #4caf50;">当前位置</h3>
                                            <p><strong>坐标:</strong> ${longitude},${latitude}</p>
                                          </div>`,
                                offset: new AMap.Pixel(0, -30)
                            });
                            
                            // 标记点击事件
                            centerMarker.on('click', function() {
                                infoWindow.open(map, centerMarker.getPosition());
                            });
                            
                            map.add(centerMarker);
                            
                            // 将地图中心移动到当前位置
                            map.setCenter([longitude, latitude]);
                            map.setZoom(16);
                        }
                        
                        showSuccess('当前位置已获取并设置');
                        updateDebugInfo(`当前位置: ${longitude},${latitude}`);
                        
                        currentLocationBtn.disabled = false;
                        currentLocationBtn.textContent = '定位当前位置';
                    },
                    function(error) {
                        let errorMessage = '获取位置失败: ';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage += '用户拒绝了位置请求';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage += '位置信息不可用';
                                break;
                            case error.TIMEOUT:
                                errorMessage += '位置请求超时';
                                break;
                            default:
                                errorMessage += '未知错误';
                        }
                        
                        showError(errorMessage);
                        updateDebugInfo(errorMessage);
                        
                        currentLocationBtn.disabled = false;
                        currentLocationBtn.textContent = '定位当前位置';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }
            
            // 地址搜索（显示多个结果）
            function searchAddress(address, apiKey) {
                const url = 'https://restapi.amap.com/v3/geocode/geo';
                const params = new URLSearchParams({
                    key: apiKey,
                    address: address,
                    output: 'json'
                });
                
                fetch(`${url}?${params.toString()}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.status === '1' && result.geocodes && result.geocodes.length > 0) {
                            displayAddressResults(result.geocodes);
                        } else {
                            addressResults.style.display = 'none';
                        }
                    })
                    .catch(error => {
                        console.error('地址搜索失败:', error);
                        addressResults.style.display = 'none';
                    });
            }
            
            // 显示地址搜索结果
            function displayAddressResults(geocodes) {
                addressResults.innerHTML = '';
                
                geocodes.forEach((geocode, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'address-result-item';
                    resultItem.innerHTML = `
                        <div class="address-name">${geocode.formatted_address}</div>
                        <div class="address-details">
                            <div>坐标: ${geocode.location}</div>
                            <div>区域: ${geocode.province} ${geocode.city} ${geocode.district}</div>
                        </div>
                    `;
                    
                    resultItem.addEventListener('click', function() {
                        // 设置坐标
                        document.getElementById('location').value = geocode.location;
                        
                        // 更新地址输入框
                        addressInput.value = geocode.formatted_address;
                        
                        // 隐藏结果列表
                        addressResults.style.display = 'none';
                        
                        // 在地图上显示该位置
                        if (isMapInitialized && map) {
                            const location = geocode.location.split(',').map(Number);
                            map.setCenter(location);
                            map.setZoom(16);
                            
                            // 更新中心点标记
                            showCenterMarker();
                        }
                        
                        showSuccess(`已选择: ${geocode.formatted_address}`);
                        updateDebugInfo(`已选择地址: ${geocode.formatted_address}, 坐标: ${geocode.location}`);
                    });
                    
                    addressResults.appendChild(resultItem);
                });
                
                addressResults.style.display = 'block';
            }
            
            // 全局函数，供信息窗口调用
            window.focusOnPoi = function(index) {
                highlightListItem(index);
            };
            
            // 确认坐标按钮点击事件
            confirmBtn.addEventListener('click', function() {
                document.getElementById('location').value = currentConvertedLocation;
                verifyArea.style.display = 'none';
                showSuccess('坐标已确认并设置');
                
                // 更新中心点标记
                if (isMapInitialized && map) {
                    showCenterMarker();
                }
            });
            
            // 拒绝坐标按钮点击事件
            rejectBtn.addEventListener('click', function() {
                verifyArea.style.display = 'none';
                showError('请重新输入地址或坐标');
            });
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                if (isSearching) {
                    showError('搜索正在进行中，请等待完成');
                    return;
                }
                
                // 验证必填字段
                const apiKey = document.getElementById('apiKey').value.trim();
                const location = document.getElementById('location').value.trim();
                
                if (!apiKey) {
                    showError('请输入高德Web服务API Key');
                    updateDebugInfo('错误: 未输入API Key');
                    return;
                }
                
                if (!location) {
                    showError('请输入中心点坐标');
                    updateDebugInfo('错误: 未输入坐标');
                    return;
                }
                
                // 验证坐标格式
                const locationParts = location.split(',');
                if (locationParts.length !== 2 || isNaN(parseFloat(locationParts[0])) || isNaN(parseFloat(locationParts[1]))) {
                    showError('坐标格式不正确，应为"经度,纬度"格式');
                    updateDebugInfo('错误: 坐标格式不正确');
                    return;
                }
                
                // 重置状态
                resetUI();
                searchResults = [];
                isSearching = true;
                
                // 获取搜索参数
                const params = {
                    apiKey: apiKey,
                    location: location,
                    keywords: document.getElementById('keywords').value.trim(),
                    types: $('#types').val() || [], // 使用Select2获取多选值
                    radius: document.getElementById('radius').value,
                    region: document.getElementById('region').value.trim(),
                    cityLimit: document.getElementById('cityLimit').value,
                    sortRule: document.getElementById('sortRule').value,
                    pageSize: document.getElementById('pageSize').value,
                    maxPages: document.getElementById('maxPages').value,
                    requestDelay: document.getElementById('requestDelay').value
                };
                
                updateDebugInfo(`开始搜索，参数: ${JSON.stringify(params)}`);
                
                // 执行搜索
                performSearch(params);
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', function() {
                if (searchResults.length === 0) {
                    showError('没有数据可下载');
                    return;
                }
                
                // 确保CSV内容已生成
                if (!csvContent) {
                    csvContent = generateCSVContent(searchResults);
                }
                
                downloadCSV(searchResults);
            });
            
            // 复制按钮点击事件
            copyBtn.addEventListener('click', function() {
                // 确保CSV内容已生成
                if (!csvContent) {
                    if (searchResults.length === 0) {
                        showError('没有数据可复制');
                        return;
                    }
                    csvContent = generateCSVContent(searchResults);
                }
                
                copyToClipboard(csvContent);
            });
            
            // 显示CSV数据按钮点击事件
            exportBtn.addEventListener('click', function() {
                // 确保CSV内容已生成
                if (!csvContent) {
                    if (searchResults.length === 0) {
                        showError('没有数据可显示');
                        return;
                    }
                    csvContent = generateCSVContent(searchResults);
                }
                
                csvData.value = csvContent;
                exportArea.style.display = 'block';
                showSuccess('CSV数据已显示在下方文本框中，可全选复制');
            });
            
            // 地址转坐标函数
            async function convertAddressToCoordinates(address, apiKey) {
                convertBtn.disabled = true;
                convertBtn.textContent = '转换中...';
                showError('');
                showSuccess('');
                updateDebugInfo(`开始地址转坐标: ${address}`);
                
                try {
                    const url = 'https://restapi.amap.com/v3/geocode/geo';
                    const params = new URLSearchParams({
                        key: apiKey,
                        address: address,
                        output: 'json'
                    });
                    
                    updateDebugInfo(`请求URL: ${url}?${params.toString().replace(apiKey, '***')}`);
                    
                    const response = await fetch(`${url}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    updateDebugInfo(`地址转换响应: ${JSON.stringify(result)}`);
                    
                    if (result.status === '1' && result.geocodes && result.geocodes.length > 0) {
                        if (result.geocodes.length === 1) {
                            // 只有一个结果，直接使用
                            const location = result.geocodes[0].location;
                            currentConvertedLocation = location;
                            updateDebugInfo(`转换成功，坐标: ${location}`);
                            
                            // 验证坐标准确性
                            await verifyCoordinates(location, apiKey);
                        } else {
                            // 多个结果，显示供用户选择
                            displayAddressResults(result.geocodes);
                            showSuccess(`找到 ${result.geocodes.length} 个匹配地址，请选择一个`);
                            updateDebugInfo(`找到 ${result.geocodes.length} 个匹配地址`);
                        }
                    } else {
                        throw new Error(result.info || '地址转换失败');
                    }
                } catch (error) {
                    const errorMsg = `地址转换失败: ${error.message}`;
                    showError(errorMsg);
                    updateDebugInfo(errorMsg);
                } finally {
                    convertBtn.disabled = false;
                    convertBtn.textContent = '获取坐标';
                }
            }
            
            // 验证坐标准确性
            async function verifyCoordinates(location, apiKey) {
                try {
                    const url = 'https://restapi.amap.com/v3/geocode/regeo';
                    const params = new URLSearchParams({
                        key: apiKey,
                        location: location,
                        output: 'json',
                        extensions: 'base'
                    });
                    
                    updateDebugInfo(`验证坐标URL: ${url}?${params.toString().replace(apiKey, '***')}`);
                    
                    const response = await fetch(`${url}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    updateDebugInfo(`坐标验证响应: ${JSON.stringify(result)}`);
                    
                    if (result.status === '1' && result.regeocode) {
                        const address = result.regeocode.formatted_address;
                        verifyAddress.innerHTML = `
                            <strong>坐标对应地址:</strong><br>
                            ${address}<br><br>
                            <strong>坐标:</strong> ${location}
                        `;
                        verifyArea.style.display = 'block';
                        showSuccess('坐标已获取，请确认地址是否正确');
                        updateDebugInfo('坐标验证成功');
                    } else {
                        throw new Error('坐标验证失败');
                    }
                } catch (error) {
                    const errorMsg = `坐标验证失败: ${error.message}`;
                    showError(errorMsg);
                    updateDebugInfo(errorMsg);
                }
            }
            
            // 执行搜索
            async function performSearch(params) {
                searchBtn.disabled = true;
                searchBtn.textContent = '搜索中...';
                status.textContent = '开始搜索...';
                isSearching = true;
                
                try {
                    const totalPages = parseInt(params.maxPages);
                    let currentPage = 1;
                    let totalCount = 0;
                    let requestDelay = parseInt(params.requestDelay) || 500;
                    
                    updateDebugInfo(`开始搜索，总页数: ${totalPages}, 延时: ${requestDelay}ms`);
                    
                    while (currentPage <= totalPages) {
                        status.textContent = `正在获取第 ${currentPage}/${totalPages} 页数据...`;
                        progress.style.width = `${(currentPage / totalPages) * 100}%`;
                        updateDebugInfo(`正在请求第 ${currentPage} 页数据`);
                        
                        const pageData = await fetchPageData(params, currentPage);
                        
                        if (!pageData) {
                            const errorMsg = `第 ${currentPage} 页请求失败`;
                            showError(errorMsg);
                            updateDebugInfo(errorMsg);
                            break;
                        }
                        
                        updateDebugInfo(`第 ${currentPage} 页响应: ${JSON.stringify(pageData).substring(0, 200)}...`);
                        
                        if (pageData.status !== '1') {
                            if (pageData.info && pageData.info.includes('CUQPS_HAS_EXCEEDED_THE_LIMIT')) {
                                const errorMsg = 'API请求频率超限，请增加请求延时或稍后再试';
                                showError(errorMsg);
                                updateDebugInfo(errorMsg);
                                break;
                            } else {
                                const errorMsg = `第 ${currentPage} 页请求失败: ${pageData.info || '未知错误'}`;
                                showError(errorMsg);
                                updateDebugInfo(errorMsg);
                                break;
                            }
                        }
                        
                        // 如果是第一页，获取总数量
                        if (currentPage === 1) {
                            totalCount = parseInt(pageData.count);
                            status.textContent = `搜索成功! 总共找到 ${totalCount} 个POI`;
                            updateDebugInfo(`总POI数量: ${totalCount}`);
                        }
                        
                        // 添加当前页数据
                        if (pageData.pois && pageData.pois.length > 0) {
                            searchResults.push(...pageData.pois);
                            updateResultDisplay(searchResults);
                            updateDebugInfo(`第 ${currentPage} 页获取到 ${pageData.pois.length} 条数据`);
                        } else {
                            updateDebugInfo(`第 ${currentPage} 页无数据`);
                        }
                        
                        // 如果当前页数据少于页面大小，说明是最后一页
                        if (pageData.pois.length < parseInt(params.pageSize)) {
                            status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                            updateDebugInfo(`数据获取完成，实际获取 ${searchResults.length} 条数据`);
                            break;
                        }
                        
                        currentPage++;
                        
                        // 添加延时，避免请求过快
                        updateDebugInfo(`等待 ${requestDelay}ms 后请求下一页`);
                        await new Promise(resolve => setTimeout(resolve, requestDelay));
                    }
                    
                    if (searchResults.length > 0) {
                        status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                        downloadBtn.disabled = false;
                        copyBtn.disabled = false;
                        exportBtn.disabled = false;
                        
                        // 生成CSV内容
                        csvContent = generateCSVContent(searchResults);
                        
                        // 在地图上显示标记
                        addMarkersToMap(searchResults);
                        
                        showSuccess('搜索完成，可以选择下载、复制或显示CSV数据');
                        updateDebugInfo('搜索完成，CSV内容已生成，地图标记已添加');
                    } else {
                        status.textContent = '未找到任何数据';
                        updateDebugInfo('搜索完成，未找到数据');
                    }
                    
                } catch (error) {
                    const errorMsg = `搜索失败: ${error.message}`;
                    showError(errorMsg);
                    updateDebugInfo(errorMsg);
                    console.error('搜索错误:', error);
                } finally {
                    searchBtn.disabled = false;
                    searchBtn.textContent = '开始搜索';
                    progress.style.width = '100%';
                    isSearching = false;
                    updateDebugInfo('搜索过程结束');
                }
            }
            
            // 获取单页数据 - 修复版：使用v3 API并正确处理参数
            async function fetchPageData(params, pageNum) {
                // 使用v3接口而不是v5接口
                const url = 'https://restapi.amap.com/v3/place/around';
                
                // 构建请求参数
                const requestParams = new URLSearchParams({
                    key: params.apiKey,
                    location: params.location,
                    radius: params.radius,
                    sortrule: params.sortRule,
                    offset: params.pageSize, // v3使用offset而不是page_size
                    page: pageNum, // v3使用page而不是page_num
                    extensions: 'all', // 必须添加这个参数来获取biz_ext等深度信息
                    output: 'json'
                });
                
                // 添加可选参数
                if (params.keywords) requestParams.append('keywords', params.keywords);
                if (params.types && params.types.length > 0) requestParams.append('types', params.types.join('|'));
                if (params.region) requestParams.append('city', params.region); // v3使用city而不是region
                if (params.cityLimit) requestParams.append('city_limit', params.cityLimit);
                
                const fullUrl = `${url}?${requestParams.toString()}`;
                updateDebugInfo(`请求URL: ${fullUrl.replace(params.apiKey, '***')}`);
                
                try {
                    const response = await fetch(fullUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('请求失败:', error);
                    updateDebugInfo(`请求失败: ${error.message}`);
                    return null;
                }
            }
            
            // 更新结果显示 - 修复版：显示图片并添加点击事件
            function updateResultDisplay(pois) {
                resultArea.innerHTML = '';
                
                if (pois.length === 0) {
                    resultArea.innerHTML = '<div class="no-data">未找到任何数据</div>';
                    return;
                }
                
                pois.forEach((poi, index) => {
                    const poiElement = document.createElement('div');
                    poiElement.className = 'poi-item';
                    poiElement.dataset.index = index;
                    
                    // 处理biz_ext字段 - 从字符串解析为对象
                    let bizExt = {};
                    try {
                        if (poi.biz_ext && typeof poi.biz_ext === 'string') {
                            bizExt = JSON.parse(poi.biz_ext);
                        } else if (poi.biz_ext && typeof poi.biz_ext === 'object') {
                            bizExt = poi.biz_ext;
                        }
                    } catch (e) {
                        console.warn('解析biz_ext失败:', e);
                    }
                    
                    // 获取评分和人均消费
                    const rating = bizExt.rating || poi.rating || '无';
                    const cost = bizExt.cost || poi.cost || '无';
                    const telephone = poi.tel || '无';
                    const distance = poi.distance || '无';
                    const distanceText = distance === '无' ? distance : `${distance}米`;
                    
                    // 处理图片链接，显示图片缩略图
                    const photos = poi.photos || [];
                    let photoHtml = '';
                    
                    if (photos.length > 0) {
                        photoHtml = '<div>图片:</div><div class="poi-images">';
                        
                        photos.forEach((photo, imgIndex) => {
                            if (photo.url) {
                                photoHtml += `
                                    <img src="${photo.url}?width=100&height=75" 
                                         alt="POI图片${imgIndex + 1}" 
                                         class="poi-image"
                                         onclick="showImageModal('${photo.url}')"
                                         title="点击查看大图">
                                `;
                            }
                        });
                        
                        photoHtml += '</div>';
                        if (photos.length > 6) {
                            photoHtml += `<div class="help-text">共 ${photos.length} 张图片，更多图片请查看详情页</div>`;
                        }
                    }
                    
                    poiElement.innerHTML = `
                        <div class="poi-name">${index + 1}. ${poi.name || '未知名称'}</div>
                        <div class="poi-details">
                            <div>地址: ${poi.address || '未知地址'}</div>
                            <div>电话: ${telephone}</div>
                            <div>评分: ${rating}</div>
                            <div>人均消费: ${cost}</div>
                            <div>距离: ${distanceText}</div>
                            <div>类型: ${poi.type || '未知类型'}</div>
                            ${photoHtml || '<div>图片: 无</div>'}
                        </div>
                    `;
                    
                    // 添加点击事件，点击列表项时在地图上高亮对应标记
                    poiElement.addEventListener('click', function() {
                        const itemIndex = parseInt(this.dataset.index);
                        highlightListItem(itemIndex);
                        
                        // 在地图上高亮对应标记
                        if (isMapInitialized && markers[itemIndex]) {
                            // 关闭所有信息窗口
                            infoWindows.forEach(iw => iw.close());
                            // 打开当前信息窗口
                            infoWindows[itemIndex].open(map, markers[itemIndex].getPosition());
                            // 将地图中心移动到标记位置
                            map.setCenter(markers[itemIndex].getPosition());
                            map.setZoom(16);
                        }
                    });
                    
                    resultArea.appendChild(poiElement);
                });
            }
            
            // 图片模态框显示函数
            window.showImageModal = function(imageUrl) {
                modalImage.src = imageUrl;
                imageModal.style.display = 'flex';
            };
            
            // 生成CSV内容 - 修复版：正确处理biz_ext字段和字符串类型
            function generateCSVContent(pois) {
                // CSV标题行
                const headers = ['名称', 'ID', '坐标', '类型', '分类编码', '地址', '省份', '城市', '区县', '电话', '评分', '人均消费', '距离(米)', '商圈', '图片链接1', '图片链接2', '图片链接3'];
                
                // 构建CSV内容
                let csvContent = headers.join(',') + '\n';
                
                pois.forEach(poi => {
                    // 处理biz_ext字段
                    let bizExt = {};
                    try {
                        if (poi.biz_ext && typeof poi.biz_ext === 'string') {
                            bizExt = JSON.parse(poi.biz_ext);
                        } else if (poi.biz_ext && typeof poi.biz_ext === 'object') {
                            bizExt = poi.biz_ext;
                        }
                    } catch (e) {
                        console.warn('解析biz_ext失败:', e);
                    }
                    
                    // 获取评分和人均消费
                    const rating = bizExt.rating || poi.rating || '';
                    const cost = bizExt.cost || poi.cost || '';
                    const telephone = poi.tel || '';
                    const distance = poi.distance || '';
                    
                    // 处理图片链接，最多导出3个
                    const photos = poi.photos || [];
                    const photoUrl1 = photos.length > 0 && photos[0].url ? photos[0].url : '';
                    const photoUrl2 = photos.length > 1 && photos[1].url ? photos[1].url : '';
                    const photoUrl3 = photos.length > 2 && photos[2].url ? photos[2].url : '';
                    
                    // 确保所有值都是字符串再调用replace方法
                    const row = [
                        `"${String(poi.name || '').replace(/"/g, '""')}"`,
                        `"${poi.id || ''}"`,
                        `"${poi.location || ''}"`,
                        `"${String(poi.type || '').replace(/"/g, '""')}"`,
                        `"${poi.typecode || ''}"`,
                        `"${String(poi.address || '').replace(/"/g, '""')}"`,
                        `"${poi.pname || ''}"`,
                        `"${poi.cityname || ''}"`,
                        `"${poi.adname || ''}"`,
                        `"${telephone}"`,
                        `"${rating}"`,
                        `"${cost}"`,
                        `"${distance}"`,
                        `"${photoUrl1}"`,
                        `"${photoUrl2}"`,
                        `"${photoUrl3}"`
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
                
                return csvContent;
            }
            
            // 下载CSV文件
            function downloadCSV(pois) {
                if (pois.length === 0) {
                    showError('没有数据可下载');
                    return;
                }
                
                if (!csvContent) {
                    csvContent = generateCSVContent(pois);
                }
                
                // 创建下载链接
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                
                // 生成文件名，包含当前日期时间
                const now = new Date();
                const dateStr = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
                link.setAttribute('download', `周边搜索_${dateStr}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // 释放URL对象
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showSuccess('CSV文件已开始下载');
                updateDebugInfo('CSV文件下载已触发');
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                if (!text || text.trim() === '') {
                    showError('没有数据可复制');
                    return;
                }
                
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showSuccess('CSV数据已复制到剪贴板');
                        updateDebugInfo('数据已复制到剪贴板');
                    } else {
                        showError('复制失败，请手动复制');
                        updateDebugInfo('复制到剪贴板失败');
                    }
                } catch (err) {
                    document.body.removeChild(textArea);
                    showError('复制失败，请手动复制');
                    updateDebugInfo('复制到剪贴板异常: ' + err.message);
                }
            }
            
            // 重置UI状态
            function resetUI() {
                resultArea.innerHTML = '';
                status.textContent = '等待搜索...';
                progress.style.width = '0%';
                downloadBtn.disabled = true;
                copyBtn.disabled = true;
                exportBtn.disabled = true;
                exportArea.style.display = 'none';
                errorArea.textContent = '';
                successArea.textContent = '';
                csvContent = '';
                updateDebugInfo('UI状态已重置');
            }
            
            // 显示错误信息
            function showError(message) {
                errorArea.textContent = message;
                successArea.textContent = '';
            }
            
            // 显示成功信息
            function showSuccess(message) {
                successArea.textContent = message;
                errorArea.textContent = '';
            }
            
            // 初始化完成
            updateDebugInfo('页面初始化完成，可以开始搜索');
            console.log('高德地图搜索工具初始化完成');
        });
    </script>
</body>
</html>