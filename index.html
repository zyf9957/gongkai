<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高德地图周边搜索工具</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #1e88e5, #0d47a1);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
        }
        
        .form-section {
            flex: 1;
            min-width: 300px;
            padding: 15px;
        }
        
        .result-section {
            flex: 2;
            min-width: 300px;
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        textarea {
            min-height: 150px;
            font-family: monospace;
            resize: vertical;
        }
        
        .help-text {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
        }
        
        button {
            background: #1e88e5;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background 0.3s;
            margin-top: 5px;
        }
        
        button:hover {
            background: #1565c0;
        }
        
        button:disabled {
            background: #90caf9;
            cursor: not-allowed;
        }
        
        .result-area {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            min-height: 200px;
            max-height: 60vh;
            overflow-y: auto;
            background: #f9f9f9;
        }
        
        .progress-bar {
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        
        .status {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        
        .poi-item {
            border-bottom: 1px solid #eee;
            padding: 10px 0;
            background: white;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .poi-item:last-child {
            border-bottom: none;
        }
        
        .poi-name {
            font-weight: bold;
            color: #1e88e5;
        }
        
        .poi-details {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        
        .download-btn {
            background: #4caf50;
        }
        
        .download-btn:hover {
            background: #388e3c;
        }
        
        .copy-btn {
            background: #ff9800;
        }
        
        .copy-btn:hover {
            background: #f57c00;
        }
        
        .export-btn {
            background: #9c27b0;
        }
        
        .export-btn:hover {
            background: #7b1fa2;
        }
        
        .error {
            color: #f44336;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .success {
            color: #4caf50;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .location-group {
            display: flex;
            gap: 10px;
        }
        
        .location-group input {
            flex: 2;
        }
        
        .location-group button {
            flex: 1;
            background: #ff9800;
        }
        
        .location-group button:hover {
            background: #f57c00;
        }
        
        .select2-container {
            width: 100% !important;
        }
        
        .verify-area {
            margin-top: 10px;
            padding: 10px;
            background: #e8f5e9;
            border-radius: 5px;
            border: 1px solid #c8e6c9;
        }
        
        .verify-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .verify-buttons button {
            flex: 1;
        }
        
        .confirm-btn {
            background: #4caf50;
        }
        
        .reject-btn {
            background: #f44336;
        }
        
        .request-delay {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .request-delay input {
            width: 80px;
        }
        
        .export-options {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .export-options button {
            flex: 1;
        }
        
        .export-area {
            margin-top: 15px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            
            .location-group {
                flex-direction: column;
            }
            
            .verify-buttons {
                flex-direction: column;
            }
            
            .export-options {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>高德地图周边搜索工具</h1>
            <p class="description">无需编程知识，轻松搜索周边地点信息</p>
        </header>
        
        <div class="content">
            <div class="form-section">
                <h2>搜索参数设置</h2>
                
                <div class="form-group">
                    <label for="apiKey">高德API Key *</label>
                    <input type="text" id="apiKey" placeholder="请输入您的高德API Key">
                    <div class="help-text">请确保您有高德地图Web服务API权限</div>
                </div>
                
                <div class="form-group">
                    <label for="address">地址转坐标</label>
                    <div class="location-group">
                        <input type="text" id="address" placeholder="输入地址，如：北京市朝阳区">
                        <button id="convertBtn">获取坐标</button>
                    </div>
                    <div class="help-text">输入地址后点击"获取坐标"按钮</div>
                </div>
                
                <div class="form-group">
                    <label for="location">中心点坐标 *</label>
                    <input type="text" id="location" placeholder="格式: 经度,纬度" value="116.473168,39.993015">
                    <div class="help-text">例如: 116.473168,39.993015 (经度在前，纬度在后)</div>
                    <div id="verifyArea" class="verify-area" style="display: none;">
                        <div id="verifyAddress"></div>
                        <div class="verify-buttons">
                            <button id="confirmBtn" class="confirm-btn">使用此坐标</button>
                            <button id="rejectBtn" class="reject-btn">重新输入</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="keywords">关键词</label>
                    <input type="text" id="keywords" placeholder="如: 餐厅、酒店等">
                    <div class="help-text">可选，用于筛选特定名称的地点</div>
                </div>
                
                <div class="form-group">
                    <label for="types">地点类型 (可多选)</label>
                    <select id="types" multiple="multiple">
                        <option value="010000">汽车服务</option>
                        <option value="020000">汽车销售</option>
                        <option value="030000">汽车维修</option>
                        <option value="040000">摩托车服务</option>
                        <option value="050000">餐饮服务</option>
                        <option value="060000">购物服务</option>
                        <option value="070000">生活服务</option>
                        <option value="080000">体育休闲服务</option>
                        <option value="090000">医疗保健服务</option>
                        <option value="100000">住宿服务</option>
                        <option value="110000">风景名胜</option>
                        <option value="120000">商务住宅</option>
                        <option value="130000">政府机构及社会团体</option>
                        <option value="140000">科教文化服务</option>
                        <option value="150000">交通设施服务</option>
                        <option value="160000">金融保险服务</option>
                        <option value="170000">公司企业</option>
                        <option value="180000">道路附属设施</option>
                        <option value="190000">地名地址信息</option>
                        <option value="200000">公共设施</option>
                        <option value="220000">事件活动</option>
                        <option value="970000">室内设施</option>
                        <option value="980000">虚拟数据</option>
                        <option value="990000">通行设施</option>
                    </select>
                    <div class="help-text">不选择则使用API默认类型(餐饮、生活服务、商务住宅)</div>
                </div>
                
                <div class="form-group">
                    <label for="radius">搜索半径 (米)</label>
                    <input type="number" id="radius" value="5000" min="0" max="50000">
                    <div class="help-text">取值范围: 0-50000，超出按默认值5000计算</div>
                </div>
                
                <div class="form-group">
                    <label for="region">搜索区域</label>
                    <input type="text" id="region" placeholder="如: 北京、上海">
                    <div class="help-text">可选，增加指定区域内数据召回权重</div>
                </div>
                
                <div class="form-group">
                    <label for="cityLimit">是否限制在区域内</label>
                    <select id="cityLimit">
                        <option value="false">否</option>
                        <option value="true">是</option>
                    </select>
                    <div class="help-text">为"是"时，仅召回指定区域内数据</div>
                </div>
                
                <div class="form-group">
                    <label for="sortRule">排序规则</label>
                    <select id="sortRule">
                        <option value="distance">按距离排序</option>
                        <option value="weight">综合排序</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="pageSize">每页数据条数</label>
                    <input type="number" id="pageSize" value="20" min="1" max="25">
                    <div class="help-text">取值范围: 1-25</div>
                </div>
                
                <div class="form-group">
                    <label for="maxPages">最大翻页数</label>
                    <input type="number" id="maxPages" value="10" min="1" max="50">
                    <div class="help-text">控制最大翻页数，每页最多25条</div>
                </div>
                
                <div class="form-group">
                    <label for="requestDelay">请求延时 (毫秒)</label>
                    <div class="request-delay">
                        <input type="number" id="requestDelay" value="500" min="100" max="5000">
                        <span>毫秒 (建议500-1000)</span>
                    </div>
                    <div class="help-text">设置请求间隔，避免超出API限制</div>
                </div>
                
                <button id="searchBtn">开始搜索</button>
            </div>
            
            <div class="result-section">
                <h2>搜索结果</h2>
                
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                
                <div class="status" id="status">等待搜索...</div>
                
                <div class="result-area" id="resultArea">
                    <!-- 搜索结果将在这里显示 -->
                </div>
                
                <div class="export-options">
                    <button id="downloadBtn" class="download-btn" disabled>下载CSV文件</button>
                    <button id="copyBtn" class="copy-btn" disabled>复制CSV数据</button>
                    <button id="exportBtn" class="export-btn" disabled>显示CSV数据</button>
                </div>
                
                <div id="exportArea" class="export-area">
                    <label for="csvData">CSV数据 (可全选复制):</label>
                    <textarea id="csvData" readonly></textarea>
                </div>
                
                <div id="errorArea" class="error"></div>
                <div id="successArea" class="success"></div>
            </div>
        </div>
    </div>

    <!-- 引入 jQuery (Select2 依赖) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- 引入 Select2 脚本 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化Select2多选下拉框
            $('#types').select2({
                placeholder: "请选择地点类型 (不选则使用默认)",
                allowClear: true,
                width: '100%'
            });
            
            const searchBtn = document.getElementById('searchBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const copyBtn = document.getElementById('copyBtn');
            const exportBtn = document.getElementById('exportBtn');
            const convertBtn = document.getElementById('convertBtn');
            const confirmBtn = document.getElementById('confirmBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const resultArea = document.getElementById('resultArea');
            const status = document.getElementById('status');
            const progress = document.getElementById('progress');
            const errorArea = document.getElementById('errorArea');
            const successArea = document.getElementById('successArea');
            const verifyArea = document.getElementById('verifyArea');
            const verifyAddress = document.getElementById('verifyAddress');
            const exportArea = document.getElementById('exportArea');
            const csvData = document.getElementById('csvData');
            
            let searchResults = [];
            let currentConvertedLocation = '';
            let csvContent = '';
            
            // 地址转坐标按钮点击事件
            convertBtn.addEventListener('click', function() {
                const address = document.getElementById('address').value.trim();
                const apiKey = document.getElementById('apiKey').value.trim();
                
                if (!address) {
                    showError('请输入地址');
                    return;
                }
                
                if (!apiKey) {
                    showError('请输入高德API Key');
                    return;
                }
                
                convertAddressToCoordinates(address, apiKey);
            });
            
            // 确认坐标按钮点击事件
            confirmBtn.addEventListener('click', function() {
                document.getElementById('location').value = currentConvertedLocation;
                verifyArea.style.display = 'none';
                showSuccess('坐标已确认并设置');
            });
            
            // 拒绝坐标按钮点击事件
            rejectBtn.addEventListener('click', function() {
                verifyArea.style.display = 'none';
                showError('请重新输入地址或坐标');
            });
            
            // 搜索按钮点击事件
            searchBtn.addEventListener('click', function() {
                // 验证必填字段
                const apiKey = document.getElementById('apiKey').value.trim();
                const location = document.getElementById('location').value.trim();
                
                if (!apiKey) {
                    showError('请输入高德API Key');
                    return;
                }
                
                if (!location) {
                    showError('请输入中心点坐标');
                    return;
                }
                
                // 验证坐标格式
                const locationParts = location.split(',');
                if (locationParts.length !== 2 || isNaN(locationParts[0]) || isNaN(locationParts[1])) {
                    showError('坐标格式不正确，应为"经度,纬度"格式');
                    return;
                }
                
                // 重置状态
                resetUI();
                searchResults = [];
                
                // 获取搜索参数
                const params = {
                    apiKey: apiKey,
                    location: location,
                    keywords: document.getElementById('keywords').value.trim(),
                    types: $('#types').val(), // 使用Select2获取多选值
                    radius: document.getElementById('radius').value,
                    region: document.getElementById('region').value.trim(),
                    cityLimit: document.getElementById('cityLimit').value,
                    sortRule: document.getElementById('sortRule').value,
                    pageSize: document.getElementById('pageSize').value,
                    maxPages: document.getElementById('maxPages').value,
                    requestDelay: document.getElementById('requestDelay').value
                };
                
                // 执行搜索
                performSearch(params);
            });
            
            // 下载按钮点击事件
            downloadBtn.addEventListener('click', function() {
                if (searchResults.length === 0) {
                    showError('没有数据可下载');
                    return;
                }
                
                downloadCSV(searchResults);
            });
            
            // 复制按钮点击事件
            copyBtn.addEventListener('click', function() {
                if (!csvContent) {
                    showError('没有数据可复制');
                    return;
                }
                
                copyToClipboard(csvContent);
            });
            
            // 显示CSV数据按钮点击事件
            exportBtn.addEventListener('click', function() {
                if (!csvContent) {
                    showError('没有数据可显示');
                    return;
                }
                
                csvData.value = csvContent;
                exportArea.style.display = 'block';
                showSuccess('CSV数据已显示在下方文本框中，可全选复制');
            });
            
            // 地址转坐标函数
            async function convertAddressToCoordinates(address, apiKey) {
                convertBtn.disabled = true;
                convertBtn.textContent = '转换中...';
                showError('');
                showSuccess('');
                
                try {
                    const url = 'https://restapi.amap.com/v3/geocode/geo';
                    const params = new URLSearchParams({
                        key: apiKey,
                        address: address,
                        output: 'json'
                    });
                    
                    const response = await fetch(`${url}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === '1' && result.geocodes && result.geocodes.length > 0) {
                        const location = result.geocodes[0].location;
                        currentConvertedLocation = location;
                        
                        // 验证坐标准确性
                        await verifyCoordinates(location, apiKey);
                        
                    } else {
                        throw new Error(result.info || '地址转换失败');
                    }
                } catch (error) {
                    showError(`地址转换失败: ${error.message}`);
                } finally {
                    convertBtn.disabled = false;
                    convertBtn.textContent = '获取坐标';
                }
            }
            
            // 验证坐标准确性
            async function verifyCoordinates(location, apiKey) {
                try {
                    const url = 'https://restapi.amap.com/v3/geocode/regeo';
                    const params = new URLSearchParams({
                        key: apiKey,
                        location: location,
                        output: 'json',
                        extensions: 'base'
                    });
                    
                    const response = await fetch(`${url}?${params.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.status === '1' && result.regeocode) {
                        const address = result.regeocode.formatted_address;
                        verifyAddress.innerHTML = `
                            <strong>坐标对应地址:</strong><br>
                            ${address}<br><br>
                            <strong>坐标:</strong> ${location}
                        `;
                        verifyArea.style.display = 'block';
                        showSuccess('坐标已获取，请确认地址是否正确');
                    } else {
                        throw new Error('坐标验证失败');
                    }
                } catch (error) {
                    showError(`坐标验证失败: ${error.message}`);
                }
            }
            
            // 执行搜索
            async function performSearch(params) {
                searchBtn.disabled = true;
                status.textContent = '开始搜索...';
                
                try {
                    const totalPages = parseInt(params.maxPages);
                    let currentPage = 1;
                    let totalCount = 0;
                    let requestDelay = parseInt(params.requestDelay) || 500;
                    
                    while (currentPage <= totalPages) {
                        status.textContent = `正在获取第 ${currentPage}/${totalPages} 页数据...`;
                        progress.style.width = `${(currentPage / totalPages) * 100}%`;
                        
                        const pageData = await fetchPageData(params, currentPage);
                        
                        if (!pageData) {
                            showError(`第 ${currentPage} 页请求失败`);
                            break;
                        }
                        
                        if (pageData.status !== '1') {
                            if (pageData.info && pageData.info.includes('CUQPS_HAS_EXCEEDED_THE_LIMIT')) {
                                showError('API请求频率超限，请增加请求延时或稍后再试');
                                break;
                            } else {
                                showError(`第 ${currentPage} 页请求失败: ${pageData.info || '未知错误'}`);
                                break;
                            }
                        }
                        
                        // 如果是第一页，获取总数量
                        if (currentPage === 1) {
                            totalCount = parseInt(pageData.count);
                            status.textContent = `搜索成功! 总共找到 ${totalCount} 个POI`;
                        }
                        
                        // 添加当前页数据
                        if (pageData.pois && pageData.pois.length > 0) {
                            searchResults.push(...pageData.pois);
                            updateResultDisplay(searchResults);
                        }
                        
                        // 如果当前页数据少于页面大小，说明是最后一页
                        if (pageData.pois.length < parseInt(params.pageSize)) {
                            status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                            break;
                        }
                        
                        currentPage++;
                        
                        // 添加延时，避免请求过快
                        await new Promise(resolve => setTimeout(resolve, requestDelay));
                    }
                    
                    if (searchResults.length > 0) {
                        status.textContent = `数据获取完成! 实际获取 ${searchResults.length} 个POI`;
                        downloadBtn.disabled = false;
                        copyBtn.disabled = false;
                        exportBtn.disabled = false;
                        
                        // 生成CSV内容
                        csvContent = generateCSVContent(searchResults);
                        showSuccess('搜索完成，可以选择下载、复制或显示CSV数据');
                    } else {
                        status.textContent = '未找到任何数据';
                    }
                    
                } catch (error) {
                    showError(`搜索失败: ${error.message}`);
                } finally {
                    searchBtn.disabled = false;
                    progress.style.width = '100%';
                }
            }
            
            // 获取单页数据
            async function fetchPageData(params, pageNum) {
                const url = 'https://restapi.amap.com/v5/place/around';
                
                // 构建请求参数
                const requestParams = new URLSearchParams({
                    key: params.apiKey,
                    location: params.location,
                    radius: params.radius,
                    sortrule: params.sortRule,
                    page_size: params.pageSize,
                    page_num: pageNum,
                    output: 'json'
                });
                
                // 添加可选参数
                if (params.keywords) requestParams.append('keywords', params.keywords);
                if (params.types && params.types.length > 0) requestParams.append('types', params.types.join('|'));
                if (params.region) requestParams.append('region', params.region);
                if (params.cityLimit) requestParams.append('city_limit', params.cityLimit);
                
                // 添加返回字段
                requestParams.append('show_fields', 'business,tel,rating,photos,cost');
                
                try {
                    const response = await fetch(`${url}?${requestParams.toString()}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP错误: ${response.status}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    console.error('请求失败:', error);
                    return null;
                }
            }
            
            // 更新结果显示
            function updateResultDisplay(pois) {
                resultArea.innerHTML = '';
                
                if (pois.length === 0) {
                    resultArea.innerHTML = '<div class="no-data">未找到任何数据</div>';
                    return;
                }
                
                pois.forEach((poi, index) => {
                    const poiElement = document.createElement('div');
                    poiElement.className = 'poi-item';
                    
                    // 处理图片链接
                    const photos = poi.photos || [];
                    const photoUrls = photos.map(photo => photo.url).filter(url => url);
                    const photoUrlsStr = photoUrls.length > 0 ? photoUrls.join(' | ') : '无';
                    
                    poiElement.innerHTML = `
                        <div class="poi-name">${index + 1}. ${poi.name || '未知名称'}</div>
                        <div class="poi-details">
                            <div>地址: ${poi.address || '未知地址'}</div>
                            <div>电话: ${poi.tel || '无'}</div>
                            <div>评分: ${poi.rating || '无'}</div>
                            <div>人均消费: ${poi.cost || '无'}</div>
                            <div>类型: ${poi.type || '未知类型'}</div>
                            <div style="word-break: break-all;">图片链接: ${photoUrlsStr}</div>
                        </div>
                    `;
                    
                    resultArea.appendChild(poiElement);
                });
            }
            
            // 生成CSV内容
            function generateCSVContent(pois) {
                // CSV标题行
                const headers = ['名称', 'ID', '坐标', '类型', '分类编码', '地址', '省份', '城市', '区县', '电话', '评分', '商圈', '人均消费', '图片链接'];
                
                // 构建CSV内容
                let csvContent = headers.join(',') + '\n';
                
                pois.forEach(poi => {
                    // 处理图片链接
                    const photos = poi.photos || [];
                    const photoUrls = photos.map(photo => photo.url).filter(url => url);
                    const photoUrlsStr = photoUrls.length > 0 ? photoUrls.join('|') : '';
                    
                    const row = [
                        `"${(poi.name || '').replace(/"/g, '""')}"`,
                        `"${poi.id || ''}"`,
                        `"${poi.location || ''}"`,
                        `"${(poi.type || '').replace(/"/g, '""')}"`,
                        `"${poi.typecode || ''}"`,
                        `"${(poi.address || '').replace(/"/g, '""')}"`,
                        `"${poi.pname || ''}"`,
                        `"${poi.cityname || ''}"`,
                        `"${poi.adname || ''}"`,
                        `"${poi.tel || ''}"`,
                        `"${poi.rating || ''}"`,
                        `"${(poi.business ? poi.business.business_area : '').replace(/"/g, '""')}"`,
                        `"${poi.cost || ''}"`,
                        `"${photoUrlsStr}"`
                    ];
                    
                    csvContent += row.join(',') + '\n';
                });
                
                return csvContent;
            }
            
            // 下载CSV文件
            function downloadCSV(pois) {
                if (!csvContent) {
                    csvContent = generateCSVContent(pois);
                if (!csvContent) {
                    showError('没有数据可下载');
                    return;
                }
                }
                
                // 创建下载链接
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `周边搜索_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showSuccess('CSV文件已开始下载');
            }
            
            // 复制到剪贴板
            function copyToClipboard(text) {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showSuccess('CSV数据已复制到剪贴板');
                    } else {
                        showError('复制失败，请手动复制');
                    }
                } catch (err) {
                    document.body.removeChild(textArea);
                    showError('复制失败，请手动复制');
                }
            }
            
            // 重置UI状态
            function resetUI() {
                resultArea.innerHTML = '';
                status.textContent = '等待搜索...';
                progress.style.width = '0%';
                downloadBtn.disabled = true;
                copyBtn.disabled = true;
                exportBtn.disabled = true;
                exportArea.style.display = 'none';
                errorArea.textContent = '';
                successArea.textContent = '';
                csvContent = '';
            }
            
            // 显示错误信息
            function showError(message) {
                errorArea.textContent = message;
                successArea.textContent = '';
            }
            
            // 显示成功信息
            function showSuccess(message) {
                successArea.textContent = message;
                errorArea.textContent = '';
            }
        });
    </script>
</body>
</html>